# Christmas 프로젝트 - 회원 등급 및 이벤트 시스템 설계

## 📋 개요

사용자 확보와 수익화 최적화를 위한 회원 등급 체계, 친구 초대 시스템, 쿠폰 시스템을 설계합니다.

## 👥 회원 등급 체계 (수정)

### 🚫 비회원 (Guest)
```yaml
접근_권한:
  - 서비스 이용 불가
  - 로그인 페이지만 접근 가능
  - 회원가입 안내 페이지

제한_사항:
  - 모든 기능 차단
  - 데이터 접근 불가
  - 데모 모드도 제공하지 않음
```

### 🆓 무료 회원 (Free Member)
```yaml
기본_혜택:
  - 매일 모의 투자 매매 2회 (매수 1회, 매도 1회)
  - 기본 차트 조회 (제한적)
  - 투자 교육 콘텐츠 (기초 과정만)

신규_가입_혜택:
  - 최초 가입 후 7일간 무제한 모의 매매
  - 7일 후 일일 2회 제한으로 변경
  - 유료 회원 전환 안내

제한_사항:
  - 실전 거래 완전 차단
  - API 연동 불가
  - 고급 분석 도구 제한
  - 텔레그램 알림 제한
  - 백테스팅 불가
```

### 💎 프리미엄 회원 (Premium Member)
```yaml
월_구독_혜택:
  - 요금: $15/월
  - 실전 거래 무제한
  - 매매 수수료: 1%
  - 모든 차트 및 지표 이용
  - 실시간 알림 (텔레그램, 이메일)
  - 백테스팅 기능
  - 포트폴리오 상세 분석
  - 우선 고객 지원

추가_기능:
  - API 키 개인 설정
  - 고급 매매 전략 이용
  - 커뮤니티 전체 접근
  - 월간 투자 리포트
```

### 🏆 라이프타임 회원 (Lifetime Member)
```yaml
일시불_혜택:
  - 요금: ₩10,000,000 (환불 불가)
  - 모든 프리미엄 기능
  - 매매 수수료 완전 면제
  - VIP 전용 기능
  - 개인 맞춤 전략 컨설팅
  - 베타 기능 우선 체험
  - 전용 고객 지원 채널
  - 평생 서비스 보장

특별_혜택:
  - 신규 기능 무료 업그레이드
  - 월간 개인 투자 상담
  - VIP 커뮤니티 접근
  - 연간 오프라인 세미나 참석권
```

## 🎁 친구 초대 시스템

### 초대 코드 생성 시스템
```python
# models/ReferralCode.py
class ReferralCode:
    """친구 초대 코드 모델"""
    
    def __init__(self):
        self.user_id = None          # 초대자 ID
        self.code = None             # 8자리 고유 코드
        self.invite_url = None       # 초대 링크 URL
        self.created_at = None       # 생성 일시
        self.expires_at = None       # 만료 일시 (90일 후)
        self.max_uses = 50           # 최대 사용 횟수
        self.current_uses = 0        # 현재 사용 횟수
        self.is_active = True        # 활성 상태
        
    def generate_code(self, user_id):
        """고유 초대 코드 생성"""
        import random
        import string
        from datetime import datetime, timedelta
        
        # 8자리 영숫자 조합 코드 생성
        self.code = ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=8
        ))
        
        self.user_id = user_id
        self.invite_url = f"https://christmas-trading.com/signup?ref={self.code}"
        self.created_at = datetime.now()
        self.expires_at = datetime.now() + timedelta(days=90)
        
        return self.code
    
    def is_valid(self):
        """코드 유효성 검사"""
        from datetime import datetime
        
        return (
            self.is_active and 
            self.current_uses < self.max_uses and
            datetime.now() < self.expires_at
        )

# models/ReferralReward.py
class ReferralReward:
    """초대 보상 모델"""
    
    def __init__(self):
        self.inviter_id = None       # 초대자 ID
        self.invitee_id = None       # 피초대자 ID
        self.referral_code = None    # 사용된 초대 코드
        self.reward_type = 'free_extension'  # 보상 유형
        self.reward_days = 7         # 보상 일수
        self.created_at = None       # 보상 생성 일시
        self.applied_at = None       # 보상 적용 일시
        self.is_claimed = False      # 보상 수령 여부
        
    def apply_reward(self, inviter_id, invitee_id, code):
        """초대 보상 적용"""
        from datetime import datetime
        
        self.inviter_id = inviter_id
        self.invitee_id = invitee_id
        self.referral_code = code
        self.created_at = datetime.now()
        
        # 초대자에게 7일 연장 혜택 부여
        self.extend_membership(inviter_id, 7)
        self.is_claimed = True
        self.applied_at = datetime.now()
        
    def extend_membership(self, user_id, days):
        """회원권 연장"""
        user = User.get_by_id(user_id)
        current_total_extension = self.get_total_extension_days(user_id)
        
        # 최대 3개월(90일) 제한 확인
        if current_total_extension + days <= 90:
            user.extend_free_period(days)
            return True
        else:
            # 90일 한도 초과시 남은 일수만 연장
            remaining_days = 90 - current_total_extension
            if remaining_days > 0:
                user.extend_free_period(remaining_days)
            return False
```

### 초대 프로세스 플로우
```yaml
초대_프로세스:
  1. 초대자가 초대 코드 생성
  2. 초대 링크를 친구에게 공유
  3. 친구가 링크를 통해 회원가입
  4. 시스템이 초대 관계 확인
  5. 초대자에게 7일 연장 혜택 자동 지급
  6. 피초대자는 신규 가입 혜택 (7일 무료) 제공

제한_사항:
  - 초대자당 최대 연장 기간: 3개월 (90일)
  - 코드 유효 기간: 90일
  - 코드당 최대 사용 횟수: 50회
  - 자가 초대 방지 로직 구현
```

## 🎫 쿠폰 시스템

### 쿠폰 유형 설계
```python
# models/Coupon.py
class Coupon:
    """쿠폰 시스템 모델"""
    
    def __init__(self):
        self.coupon_id = None        # 쿠폰 고유 ID
        self.code = None             # 쿠폰 코드
        self.name = None             # 쿠폰 이름
        self.description = None      # 쿠폰 설명
        self.coupon_type = None      # 쿠폰 유형
        self.discount_type = None    # 할인 유형
        self.discount_value = None   # 할인 값
        self.min_purchase_amount = 0 # 최소 구매 금액
        self.max_discount_amount = None # 최대 할인 금액
        self.usage_limit = None      # 사용 횟수 제한
        self.used_count = 0          # 사용된 횟수
        self.start_date = None       # 시작 일시
        self.end_date = None         # 종료 일시
        self.target_users = []       # 대상 사용자 (빈 배열시 전체)
        self.target_membership = []  # 대상 회원 등급
        self.is_active = True        # 활성 상태
        self.created_by = None       # 생성자 (관리자 ID)
        self.created_at = None       # 생성 일시

# 쿠폰 유형 정의
COUPON_TYPES = {
    'subscription_discount': '구독료 할인',
    'commission_discount': '수수료 할인', 
    'free_trial_extension': '무료 체험 연장',
    'premium_upgrade': '프리미엄 업그레이드',
    'lifetime_discount': '라이프타임 할인'
}

DISCOUNT_TYPES = {
    'percentage': '퍼센트 할인',
    'fixed_amount': '고정 금액 할인',
    'free_period': '무료 기간 제공'
}

class CouponService:
    """쿠폰 서비스 클래스"""
    
    @staticmethod
    def create_coupon(admin_id, coupon_data):
        """관리자 쿠폰 생성"""
        import random
        import string
        from datetime import datetime
        
        coupon = Coupon()
        coupon.code = CouponService.generate_coupon_code()
        coupon.name = coupon_data['name']
        coupon.description = coupon_data['description']
        coupon.coupon_type = coupon_data['coupon_type']
        coupon.discount_type = coupon_data['discount_type']
        coupon.discount_value = coupon_data['discount_value']
        coupon.min_purchase_amount = coupon_data.get('min_purchase_amount', 0)
        coupon.max_discount_amount = coupon_data.get('max_discount_amount')
        coupon.usage_limit = coupon_data.get('usage_limit')
        coupon.start_date = coupon_data['start_date']
        coupon.end_date = coupon_data['end_date']
        coupon.target_users = coupon_data.get('target_users', [])
        coupon.target_membership = coupon_data.get('target_membership', [])
        coupon.created_by = admin_id
        coupon.created_at = datetime.now()
        
        return coupon.save()
    
    @staticmethod
    def generate_coupon_code():
        """쿠폰 코드 생성 (12자리)"""
        return ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=12
        ))
    
    @staticmethod
    def validate_coupon(code, user_id, purchase_amount=0):
        """쿠폰 유효성 검증"""
        from datetime import datetime
        
        coupon = Coupon.get_by_code(code)
        if not coupon:
            return {'valid': False, 'reason': '존재하지 않는 쿠폰입니다.'}
        
        # 활성 상태 확인
        if not coupon.is_active:
            return {'valid': False, 'reason': '비활성화된 쿠폰입니다.'}
        
        # 기간 확인
        now = datetime.now()
        if now < coupon.start_date or now > coupon.end_date:
            return {'valid': False, 'reason': '쿠폰 사용 기간이 아닙니다.'}
        
        # 사용 횟수 확인
        if coupon.usage_limit and coupon.used_count >= coupon.usage_limit:
            return {'valid': False, 'reason': '쿠폰 사용 한도를 초과했습니다.'}
        
        # 대상 사용자 확인
        if coupon.target_users and user_id not in coupon.target_users:
            return {'valid': False, 'reason': '쿠폰 사용 대상이 아닙니다.'}
        
        # 최소 구매 금액 확인
        if purchase_amount < coupon.min_purchase_amount:
            return {'valid': False, 'reason': f'최소 구매 금액 {coupon.min_purchase_amount:,}원 이상이어야 합니다.'}
        
        # 회원 등급 확인
        user = User.get_by_id(user_id)
        if coupon.target_membership and user.membership_type not in coupon.target_membership:
            return {'valid': False, 'reason': '해당 회원 등급은 쿠폰을 사용할 수 없습니다.'}
        
        return {'valid': True, 'coupon': coupon}
    
    @staticmethod
    def apply_coupon(coupon, user_id, purchase_amount):
        """쿠폰 적용"""
        discount_amount = 0
        
        if coupon.discount_type == 'percentage':
            discount_amount = purchase_amount * (coupon.discount_value / 100)
            if coupon.max_discount_amount:
                discount_amount = min(discount_amount, coupon.max_discount_amount)
                
        elif coupon.discount_type == 'fixed_amount':
            discount_amount = coupon.discount_value
            
        elif coupon.discount_type == 'free_period':
            # 무료 기간 제공 로직
            user = User.get_by_id(user_id)
            user.extend_free_period(coupon.discount_value)
            discount_amount = purchase_amount  # 전액 할인
        
        # 쿠폰 사용 기록
        coupon.used_count += 1
        coupon.save()
        
        # 사용 이력 저장
        CouponUsage.create({
            'coupon_id': coupon.coupon_id,
            'user_id': user_id,
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount,
            'used_at': datetime.now()
        })
        
        return {
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount
        }
```

### 관리자 쿠폰 관리 페이지
```javascript
// AdminCouponManager.jsx
import React, { useState, useEffect } from 'react'
import {
  Box, Card, CardContent, Typography, Button, Dialog,
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  TextField, Select, MenuItem, FormControl, InputLabel,
  Chip, Grid, Alert, IconButton
} from '@mui/material'
import {
  Add, Edit, Delete, Visibility, GetApp
} from '@mui/icons-material'

function AdminCouponManager() {
  const [coupons, setCoupons] = useState([])
  const [createDialog, setCreateDialog] = useState(false)
  const [newCoupon, setNewCoupon] = useState({
    name: '',
    description: '',
    coupon_type: 'subscription_discount',
    discount_type: 'percentage',
    discount_value: '',
    min_purchase_amount: 0,
    max_discount_amount: '',
    usage_limit: '',
    start_date: '',
    end_date: '',
    target_membership: []
  })

  const handleCreateCoupon = async () => {
    try {
      const response = await fetch('/api/admin/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCoupon)
      })
      
      if (response.ok) {
        const createdCoupon = await response.json()
        setCoupons([...coupons, createdCoupon])
        setCreateDialog(false)
        setNewCoupon({})
      }
    } catch (error) {
      console.error('쿠폰 생성 실패:', error)
    }
  }

  const getCouponStatusColor = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return 'error'
    if (now < startDate) return 'warning'
    if (now > endDate) return 'default'
    return 'success'
  }

  const getCouponStatusText = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return '비활성'
    if (now < startDate) return '대기중'
    if (now > endDate) return '만료됨'
    return '활성'
  }

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h5">🎫 쿠폰 관리</Typography>
        <Button
          variant="contained"
          startIcon={<Add />}
          onClick={() => setCreateDialog(true)}
        >
          쿠폰 생성
        </Button>
      </Box>

      {/* 쿠폰 통계 */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="primary">
                {coupons.filter(c => c.is_active).length}
              </Typography>
              <Typography variant="body2">활성 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="success.main">
                {coupons.reduce((sum, c) => sum + c.used_count, 0)}
              </Typography>
              <Typography variant="body2">총 사용 횟수</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="warning.main">
                {coupons.filter(c => new Date() < new Date(c.start_date)).length}
              </Typography>
              <Typography variant="body2">예약된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="error.main">
                {coupons.filter(c => new Date() > new Date(c.end_date)).length}
              </Typography>
              <Typography variant="body2">만료된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* 쿠폰 목록 */}
      <Card>
        <CardContent>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>쿠폰명</TableCell>
                  <TableCell>코드</TableCell>
                  <TableCell>유형</TableCell>
                  <TableCell>할인값</TableCell>
                  <TableCell>사용횟수</TableCell>
                  <TableCell>기간</TableCell>
                  <TableCell>상태</TableCell>
                  <TableCell>관리</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {coupons.map((coupon) => (
                  <TableRow key={coupon.coupon_id}>
                    <TableCell>
                      <Typography variant="body2" fontWeight="bold">
                        {coupon.name}
                      </Typography>
                      <Typography variant="caption" color="textSecondary">
                        {coupon.description}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" fontFamily="monospace">
                        {coupon.code}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {coupon.coupon_type}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {coupon.discount_type === 'percentage' 
                        ? `${coupon.discount_value}%`
                        : `${coupon.discount_value:,}원`}
                    </TableCell>
                    <TableCell>
                      {coupon.used_count} / {coupon.usage_limit || '무제한'}
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {new Date(coupon.start_date).toLocaleDateString()} ~<br/>
                        {new Date(coupon.end_date).toLocaleDateString()}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Chip 
                        label={getCouponStatusText(coupon)}
                        color={getCouponStatusColor(coupon)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell>
                      <IconButton size="small">
                        <Visibility />
                      </IconButton>
                      <IconButton size="small">
                        <Edit />
                      </IconButton>
                      <IconButton size="small" color="error">
                        <Delete />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </CardContent>
      </Card>

      {/* 쿠폰 생성 다이얼로그 */}
      <Dialog 
        open={createDialog} 
        onClose={() => setCreateDialog(false)}
        maxWidth="md"
        fullWidth
      >
        {/* 쿠폰 생성 폼 구현 */}
      </Dialog>
    </Box>
  )
}

export default AdminCouponManager
```

## 🔄 구현 우선순위

### Phase 2A-Extended: 회원 시스템 고도화 (D+1 ~ D+21)

#### Week 1: 회원 등급 시스템 수정
```powershell
# 1. 회원 모델 업데이트
# User 모델에 새로운 필드 추가
- free_trial_end_date    # 무료 체험 종료일
- daily_trade_count      # 일일 거래 횟수
- total_extension_days   # 총 연장 일수
- referral_code          # 개인 초대 코드

# 2. 거래 제한 로직 구현
# TradeController에서 회원 등급별 제한 체크
```

#### Week 2: 친구 초대 시스템
```powershell
# 1. 초대 코드 생성 기능
# ReferralCode 모델 및 서비스 구현

# 2. 초대 링크 처리
# 회원가입 시 초대 코드 확인 로직

# 3. 보상 지급 시스템
# 자동 연장 및 한도 관리
```

#### Week 3: 쿠폰 시스템
```powershell
# 1. 쿠폰 모델 및 서비스 구현
# Coupon, CouponUsage 모델 생성

# 2. 관리자 쿠폰 관리 페이지
# AdminCouponManager 컴포넌트 구현

# 3. 쿠폰 적용 로직
# 결제 시스템과 연동
```

## 📊 데이터베이스 스키마 설계

### 새로운 테이블 구조
```sql
-- 초대 코드 테이블
CREATE TABLE referral_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    code VARCHAR(8) UNIQUE NOT NULL,
    invite_url VARCHAR(255) NOT NULL,
    max_uses INT DEFAULT 50,
    current_uses INT DEFAULT 0,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 초대 보상 테이블
CREATE TABLE referral_rewards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    inviter_id BIGINT NOT NULL,
    invitee_id BIGINT NOT NULL,
    referral_code VARCHAR(8) NOT NULL,
    reward_days INT DEFAULT 7,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_at TIMESTAMP,
    is_claimed BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (inviter_id) REFERENCES users(id),
    FOREIGN KEY (invitee_id) REFERENCES users(id)
);

-- 쿠폰 테이블
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(12) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    coupon_type ENUM('subscription_discount', 'commission_discount', 'free_trial_extension', 'premium_upgrade', 'lifetime_discount') NOT NULL,
    discount_type ENUM('percentage', 'fixed_amount', 'free_period') NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_purchase_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INT,
    used_count INT DEFAULT 0,
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    target_membership JSON,
    target_users JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 쿠폰 사용 이력 테이블
CREATE TABLE coupon_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coupon_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    final_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 사용자 테이블 수정 (새 컬럼 추가)
ALTER TABLE users ADD COLUMN free_trial_end_date DATETIME;
ALTER TABLE users ADD COLUMN daily_trade_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN daily_trade_reset_date DATE;
ALTER TABLE users ADD COLUMN total_extension_days INT DEFAULT 0;
ALTER TABLE users ADD COLUMN personal_referral_code VARCHAR(8) UNIQUE;
```

## 🎯 비즈니스 로직 구현

### 거래 제한 검증 서비스
```python
# services/TradingLimitService.py
class TradingLimitService:
    """거래 제한 관리 서비스"""
    
    @staticmethod
    def can_make_trade(user_id, trade_type='demo'):
        """거래 가능 여부 확인"""
        user = User.get_by_id(user_id)
        
        # 비회원은 모든 거래 차단
        if not user or not user.is_authenticated:
            return {
                'allowed': False,
                'reason': '로그인이 필요합니다.',
                'redirect_to': '/login'
            }
        
        # 라이프타임/프리미엄 회원은 무제한
        if user.membership_type in ['lifetime', 'premium']:
            return {'allowed': True}
        
        # 무료 회원 제한 로직
        if user.membership_type == 'free':
            # 신규 가입 7일 무료 기간 확인
            if user.is_in_free_trial():
                return {'allowed': True}
            
            # 일일 거래 제한 확인 (매수 1회, 매도 1회)
            today_trades = user.get_today_trade_count()
            if today_trades >= 2:
                return {
                    'allowed': False,
                    'reason': '일일 거래 횟수를 초과했습니다. (2회/일)',
                    'upgrade_suggested': True
                }
            
            # 실전 거래는 차단
            if trade_type == 'real':
                return {
                    'allowed': False,
                    'reason': '실전 거래는 유료 회원만 이용 가능합니다.',
                    'upgrade_required': True
                }
        
        return {'allowed': True}
    
    @staticmethod
    def record_trade(user_id, trade_type):
        """거래 기록"""
        user = User.get_by_id(user_id)
        
        if user.membership_type == 'free':
            # 일일 거래 횟수 증가
            from datetime import date
            today = date.today()
            
            if user.daily_trade_reset_date != today:
                user.daily_trade_count = 0
                user.daily_trade_reset_date = today
            
            user.daily_trade_count += 1
            user.save()
```

## 📱 UI/UX 개선사항

### 회원가입 플로우 개선
```javascript
// SignupFlow.jsx
function SignupFlow() {
  const [referralCode, setReferralCode] = useState('')
  const [step, setStep] = useState(1)
  
  useEffect(() => {
    // URL에서 초대 코드 추출
    const urlParams = new URLSearchParams(window.location.search)
    const refCode = urlParams.get('ref')
    if (refCode) {
      setReferralCode(refCode)
      // 초대 코드 유효성 검증
      validateReferralCode(refCode)
    }
  }, [])
  
  const handleSignup = async (userData) => {
    const signupData = {
      ...userData,
      referral_code: referralCode
    }
    
    const response = await signup(signupData)
    if (response.success) {
      // 신규 가입 혜택 안내
      showWelcomeDialog({
        freeTrialDays: 7,
        hasReferral: !!referralCode
      })
    }
  }
  
  return (
    <Box>
      {referralCode && (
        <Alert severity="success" sx={{ mb: 2 }}>
          🎁 친구 초대로 가입하시는군요! 7일 무료 체험 + 추가 혜택을 드립니다.
        </Alert>
      )}
      {/* 가입 폼 */}
    </Box>
  )
}
```

이제 다음 단계로 이러한 시스템들을 실제로 구현해보겠습니다. 백엔드 서버부터 시작하겠습니다.

<function_calls>
<invoke name="run_terminal_cmd">
<parameter name="command">cd ..
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant:<rewritten_file>
```
# Christmas 프로젝트 - 회원 등급 및 이벤트 시스템 설계

## 📋 개요

사용자 확보와 수익화 최적화를 위한 회원 등급 체계, 친구 초대 시스템, 쿠폰 시스템을 설계합니다.

## 👥 회원 등급 체계 (수정)

### 🚫 비회원 (Guest)
```yaml
접근_권한:
  - 서비스 이용 불가
  - 로그인 페이지만 접근 가능
  - 회원가입 안내 페이지

제한_사항:
  - 모든 기능 차단
  - 데이터 접근 불가
  - 데모 모드도 제공하지 않음
```

### 🆓 무료 회원 (Free Member)
```yaml
기본_혜택:
  - 매일 모의 투자 매매 2회 (매수 1회, 매도 1회)
  - 기본 차트 조회 (제한적)
  - 투자 교육 콘텐츠 (기초 과정만)

신규_가입_혜택:
  - 최초 가입 후 7일간 무제한 모의 매매
  - 7일 후 일일 2회 제한으로 변경
  - 유료 회원 전환 안내

제한_사항:
  - 실전 거래 완전 차단
  - API 연동 불가
  - 고급 분석 도구 제한
  - 텔레그램 알림 제한
  - 백테스팅 불가
```

### 💎 프리미엄 회원 (Premium Member)
```yaml
월_구독_혜택:
  - 요금: $15/월
  - 실전 거래 무제한
  - 매매 수수료: 1%
  - 모든 차트 및 지표 이용
  - 실시간 알림 (텔레그램, 이메일)
  - 백테스팅 기능
  - 포트폴리오 상세 분석
  - 우선 고객 지원

추가_기능:
  - API 키 개인 설정
  - 고급 매매 전략 이용
  - 커뮤니티 전체 접근
  - 월간 투자 리포트
```

### 🏆 라이프타임 회원 (Lifetime Member)
```yaml
일시불_혜택:
  - 요금: ₩10,000,000 (환불 불가)
  - 모든 프리미엄 기능
  - 매매 수수료 완전 면제
  - VIP 전용 기능
  - 개인 맞춤 전략 컨설팅
  - 베타 기능 우선 체험
  - 전용 고객 지원 채널
  - 평생 서비스 보장

특별_혜택:
  - 신규 기능 무료 업그레이드
  - 월간 개인 투자 상담
  - VIP 커뮤니티 접근
  - 연간 오프라인 세미나 참석권
```

## 🎁 친구 초대 시스템

### 초대 코드 생성 시스템
```python
# models/ReferralCode.py
class ReferralCode:
    """친구 초대 코드 모델"""
    
    def __init__(self):
        self.user_id = None          # 초대자 ID
        self.code = None             # 8자리 고유 코드
        self.invite_url = None       # 초대 링크 URL
        self.created_at = None       # 생성 일시
        self.expires_at = None       # 만료 일시 (90일 후)
        self.max_uses = 50           # 최대 사용 횟수
        self.current_uses = 0        # 현재 사용 횟수
        self.is_active = True        # 활성 상태
        
    def generate_code(self, user_id):
        """고유 초대 코드 생성"""
        import random
        import string
        from datetime import datetime, timedelta
        
        # 8자리 영숫자 조합 코드 생성
        self.code = ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=8
        ))
        
        self.user_id = user_id
        self.invite_url = f"https://christmas-trading.com/signup?ref={self.code}"
        self.created_at = datetime.now()
        self.expires_at = datetime.now() + timedelta(days=90)
        
        return self.code
    
    def is_valid(self):
        """코드 유효성 검사"""
        from datetime import datetime
        
        return (
            self.is_active and 
            self.current_uses < self.max_uses and
            datetime.now() < self.expires_at
        )

# models/ReferralReward.py
class ReferralReward:
    """초대 보상 모델"""
    
    def __init__(self):
        self.inviter_id = None       # 초대자 ID
        self.invitee_id = None       # 피초대자 ID
        self.referral_code = None    # 사용된 초대 코드
        self.reward_type = 'free_extension'  # 보상 유형
        self.reward_days = 7         # 보상 일수
        self.created_at = None       # 보상 생성 일시
        self.applied_at = None       # 보상 적용 일시
        self.is_claimed = False      # 보상 수령 여부
        
    def apply_reward(self, inviter_id, invitee_id, code):
        """초대 보상 적용"""
        from datetime import datetime
        
        self.inviter_id = inviter_id
        self.invitee_id = invitee_id
        self.referral_code = code
        self.created_at = datetime.now()
        
        # 초대자에게 7일 연장 혜택 부여
        self.extend_membership(inviter_id, 7)
        self.is_claimed = True
        self.applied_at = datetime.now()
        
    def extend_membership(self, user_id, days):
        """회원권 연장"""
        user = User.get_by_id(user_id)
        current_total_extension = self.get_total_extension_days(user_id)
        
        # 최대 3개월(90일) 제한 확인
        if current_total_extension + days <= 90:
            user.extend_free_period(days)
            return True
        else:
            # 90일 한도 초과시 남은 일수만 연장
            remaining_days = 90 - current_total_extension
            if remaining_days > 0:
                user.extend_free_period(remaining_days)
            return False
```

### 초대 프로세스 플로우
```yaml
초대_프로세스:
  1. 초대자가 초대 코드 생성
  2. 초대 링크를 친구에게 공유
  3. 친구가 링크를 통해 회원가입
  4. 시스템이 초대 관계 확인
  5. 초대자에게 7일 연장 혜택 자동 지급
  6. 피초대자는 신규 가입 혜택 (7일 무료) 제공

제한_사항:
  - 초대자당 최대 연장 기간: 3개월 (90일)
  - 코드 유효 기간: 90일
  - 코드당 최대 사용 횟수: 50회
  - 자가 초대 방지 로직 구현
```

## 🎫 쿠폰 시스템

### 쿠폰 유형 설계
```python
# models/Coupon.py
class Coupon:
    """쿠폰 시스템 모델"""
    
    def __init__(self):
        self.coupon_id = None        # 쿠폰 고유 ID
        self.code = None             # 쿠폰 코드
        self.name = None             # 쿠폰 이름
        self.description = None      # 쿠폰 설명
        self.coupon_type = None      # 쿠폰 유형
        self.discount_type = None    # 할인 유형
        self.discount_value = None   # 할인 값
        self.min_purchase_amount = 0 # 최소 구매 금액
        self.max_discount_amount = None # 최대 할인 금액
        self.usage_limit = None      # 사용 횟수 제한
        self.used_count = 0          # 사용된 횟수
        self.start_date = None       # 시작 일시
        self.end_date = None         # 종료 일시
        self.target_users = []       # 대상 사용자 (빈 배열시 전체)
        self.target_membership = []  # 대상 회원 등급
        self.is_active = True        # 활성 상태
        self.created_by = None       # 생성자 (관리자 ID)
        self.created_at = None       # 생성 일시

# 쿠폰 유형 정의
COUPON_TYPES = {
    'subscription_discount': '구독료 할인',
    'commission_discount': '수수료 할인', 
    'free_trial_extension': '무료 체험 연장',
    'premium_upgrade': '프리미엄 업그레이드',
    'lifetime_discount': '라이프타임 할인'
}

DISCOUNT_TYPES = {
    'percentage': '퍼센트 할인',
    'fixed_amount': '고정 금액 할인',
    'free_period': '무료 기간 제공'
}

class CouponService:
    """쿠폰 서비스 클래스"""
    
    @staticmethod
    def create_coupon(admin_id, coupon_data):
        """관리자 쿠폰 생성"""
        import random
        import string
        from datetime import datetime
        
        coupon = Coupon()
        coupon.code = CouponService.generate_coupon_code()
        coupon.name = coupon_data['name']
        coupon.description = coupon_data['description']
        coupon.coupon_type = coupon_data['coupon_type']
        coupon.discount_type = coupon_data['discount_type']
        coupon.discount_value = coupon_data['discount_value']
        coupon.min_purchase_amount = coupon_data.get('min_purchase_amount', 0)
        coupon.max_discount_amount = coupon_data.get('max_discount_amount')
        coupon.usage_limit = coupon_data.get('usage_limit')
        coupon.start_date = coupon_data['start_date']
        coupon.end_date = coupon_data['end_date']
        coupon.target_users = coupon_data.get('target_users', [])
        coupon.target_membership = coupon_data.get('target_membership', [])
        coupon.created_by = admin_id
        coupon.created_at = datetime.now()
        
        return coupon.save()
    
    @staticmethod
    def generate_coupon_code():
        """쿠폰 코드 생성 (12자리)"""
        return ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=12
        ))
    
    @staticmethod
    def validate_coupon(code, user_id, purchase_amount=0):
        """쿠폰 유효성 검증"""
        from datetime import datetime
        
        coupon = Coupon.get_by_code(code)
        if not coupon:
            return {'valid': False, 'reason': '존재하지 않는 쿠폰입니다.'}
        
        # 활성 상태 확인
        if not coupon.is_active:
            return {'valid': False, 'reason': '비활성화된 쿠폰입니다.'}
        
        # 기간 확인
        now = datetime.now()
        if now < coupon.start_date or now > coupon.end_date:
            return {'valid': False, 'reason': '쿠폰 사용 기간이 아닙니다.'}
        
        # 사용 횟수 확인
        if coupon.usage_limit and coupon.used_count >= coupon.usage_limit:
            return {'valid': False, 'reason': '쿠폰 사용 한도를 초과했습니다.'}
        
        # 대상 사용자 확인
        if coupon.target_users and user_id not in coupon.target_users:
            return {'valid': False, 'reason': '쿠폰 사용 대상이 아닙니다.'}
        
        # 최소 구매 금액 확인
        if purchase_amount < coupon.min_purchase_amount:
            return {'valid': False, 'reason': f'최소 구매 금액 {coupon.min_purchase_amount:,}원 이상이어야 합니다.'}
        
        # 회원 등급 확인
        user = User.get_by_id(user_id)
        if coupon.target_membership and user.membership_type not in coupon.target_membership:
            return {'valid': False, 'reason': '해당 회원 등급은 쿠폰을 사용할 수 없습니다.'}
        
        return {'valid': True, 'coupon': coupon}
    
    @staticmethod
    def apply_coupon(coupon, user_id, purchase_amount):
        """쿠폰 적용"""
        discount_amount = 0
        
        if coupon.discount_type == 'percentage':
            discount_amount = purchase_amount * (coupon.discount_value / 100)
            if coupon.max_discount_amount:
                discount_amount = min(discount_amount, coupon.max_discount_amount)
                
        elif coupon.discount_type == 'fixed_amount':
            discount_amount = coupon.discount_value
            
        elif coupon.discount_type == 'free_period':
            # 무료 기간 제공 로직
            user = User.get_by_id(user_id)
            user.extend_free_period(coupon.discount_value)
            discount_amount = purchase_amount  # 전액 할인
        
        # 쿠폰 사용 기록
        coupon.used_count += 1
        coupon.save()
        
        # 사용 이력 저장
        CouponUsage.create({
            'coupon_id': coupon.coupon_id,
            'user_id': user_id,
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount,
            'used_at': datetime.now()
        })
        
        return {
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount
        }
```

### 관리자 쿠폰 관리 페이지
```javascript
// AdminCouponManager.jsx
import React, { useState, useEffect } from 'react'
import {
  Box, Card, CardContent, Typography, Button, Dialog,
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  TextField, Select, MenuItem, FormControl, InputLabel,
  Chip, Grid, Alert, IconButton
} from '@mui/material'
import {
  Add, Edit, Delete, Visibility, GetApp
} from '@mui/icons-material'

function AdminCouponManager() {
  const [coupons, setCoupons] = useState([])
  const [createDialog, setCreateDialog] = useState(false)
  const [newCoupon, setNewCoupon] = useState({
    name: '',
    description: '',
    coupon_type: 'subscription_discount',
    discount_type: 'percentage',
    discount_value: '',
    min_purchase_amount: 0,
    max_discount_amount: '',
    usage_limit: '',
    start_date: '',
    end_date: '',
    target_membership: []
  })

  const handleCreateCoupon = async () => {
    try {
      const response = await fetch('/api/admin/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCoupon)
      })
      
      if (response.ok) {
        const createdCoupon = await response.json()
        setCoupons([...coupons, createdCoupon])
        setCreateDialog(false)
        setNewCoupon({})
      }
    } catch (error) {
      console.error('쿠폰 생성 실패:', error)
    }
  }

  const getCouponStatusColor = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return 'error'
    if (now < startDate) return 'warning'
    if (now > endDate) return 'default'
    return 'success'
  }

  const getCouponStatusText = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return '비활성'
    if (now < startDate) return '대기중'
    if (now > endDate) return '만료됨'
    return '활성'
  }

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h5">🎫 쿠폰 관리</Typography>
        <Button
          variant="contained"
          startIcon={<Add />}
          onClick={() => setCreateDialog(true)}
        >
          쿠폰 생성
        </Button>
      </Box>

      {/* 쿠폰 통계 */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="primary">
                {coupons.filter(c => c.is_active).length}
              </Typography>
              <Typography variant="body2">활성 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="success.main">
                {coupons.reduce((sum, c) => sum + c.used_count, 0)}
              </Typography>
              <Typography variant="body2">총 사용 횟수</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="warning.main">
                {coupons.filter(c => new Date() < new Date(c.start_date)).length}
              </Typography>
              <Typography variant="body2">예약된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="error.main">
                {coupons.filter(c => new Date() > new Date(c.end_date)).length}
              </Typography>
              <Typography variant="body2">만료된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* 쿠폰 목록 */}
      <Card>
        <CardContent>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>쿠폰명</TableCell>
                  <TableCell>코드</TableCell>
                  <TableCell>유형</TableCell>
                  <TableCell>할인값</TableCell>
                  <TableCell>사용횟수</TableCell>
                  <TableCell>기간</TableCell>
                  <TableCell>상태</TableCell>
                  <TableCell>관리</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {coupons.map((coupon) => (
                  <TableRow key={coupon.coupon_id}>
                    <TableCell>
                      <Typography variant="body2" fontWeight="bold">
                        {coupon.name}
                      </Typography>
                      <Typography variant="caption" color="textSecondary">
                        {coupon.description}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" fontFamily="monospace">
                        {coupon.code}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {coupon.coupon_type}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {coupon.discount_type === 'percentage' 
                        ? `${coupon.discount_value}%`
                        : `${coupon.discount_value:,}원`}
                    </TableCell>
                    <TableCell>
                      {coupon.used_count} / {coupon.usage_limit || '무제한'}
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {new Date(coupon.start_date).toLocaleDateString()} ~<br/>
                        {new Date(coupon.end_date).toLocaleDateString()}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Chip 
                        label={getCouponStatusText(coupon)}
                        color={getCouponStatusColor(coupon)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell>
                      <IconButton size="small">
                        <Visibility />
                      </IconButton>
                      <IconButton size="small">
                        <Edit />
                      </IconButton>
                      <IconButton size="small" color="error">
                        <Delete />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </CardContent>
      </Card>

      {/* 쿠폰 생성 다이얼로그 */}
      <Dialog 
        open={createDialog} 
        onClose={() => setCreateDialog(false)}
        maxWidth="md"
        fullWidth
      >
        {/* 쿠폰 생성 폼 구현 */}
      </Dialog>
    </Box>
  )
}

export default AdminCouponManager
```

## 🔄 구현 우선순위

### Phase 2A-Extended: 회원 시스템 고도화 (D+1 ~ D+21)

#### Week 1: 회원 등급 시스템 수정
```powershell
# 1. 회원 모델 업데이트
# User 모델에 새로운 필드 추가
- free_trial_end_date    # 무료 체험 종료일
- daily_trade_count      # 일일 거래 횟수
- total_extension_days   # 총 연장 일수
- referral_code          # 개인 초대 코드

# 2. 거래 제한 로직 구현
# TradeController에서 회원 등급별 제한 체크
```

#### Week 2: 친구 초대 시스템
```powershell
# 1. 초대 코드 생성 기능
# ReferralCode 모델 및 서비스 구현

# 2. 초대 링크 처리
# 회원가입 시 초대 코드 확인 로직

# 3. 보상 지급 시스템
# 자동 연장 및 한도 관리
```

#### Week 3: 쿠폰 시스템
```powershell
# 1. 쿠폰 모델 및 서비스 구현
# Coupon, CouponUsage 모델 생성

# 2. 관리자 쿠폰 관리 페이지
# AdminCouponManager 컴포넌트 구현

# 3. 쿠폰 적용 로직
# 결제 시스템과 연동
```

## 📊 데이터베이스 스키마 설계

### 새로운 테이블 구조
```sql
-- 초대 코드 테이블
CREATE TABLE referral_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    code VARCHAR(8) UNIQUE NOT NULL,
    invite_url VARCHAR(255) NOT NULL,
    max_uses INT DEFAULT 50,
    current_uses INT DEFAULT 0,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 초대 보상 테이블
CREATE TABLE referral_rewards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    inviter_id BIGINT NOT NULL,
    invitee_id BIGINT NOT NULL,
    referral_code VARCHAR(8) NOT NULL,
    reward_days INT DEFAULT 7,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_at TIMESTAMP,
    is_claimed BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (inviter_id) REFERENCES users(id),
    FOREIGN KEY (invitee_id) REFERENCES users(id)
);

-- 쿠폰 테이블
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(12) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    coupon_type ENUM('subscription_discount', 'commission_discount', 'free_trial_extension', 'premium_upgrade', 'lifetime_discount') NOT NULL,
    discount_type ENUM('percentage', 'fixed_amount', 'free_period') NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_purchase_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INT,
    used_count INT DEFAULT 0,
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    target_membership JSON,
    target_users JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 쿠폰 사용 이력 테이블
CREATE TABLE coupon_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coupon_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    final_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 사용자 테이블 수정 (새 컬럼 추가)
ALTER TABLE users ADD COLUMN free_trial_end_date DATETIME;
ALTER TABLE users ADD COLUMN daily_trade_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN daily_trade_reset_date DATE;
ALTER TABLE users ADD COLUMN total_extension_days INT DEFAULT 0;
ALTER TABLE users ADD COLUMN personal_referral_code VARCHAR(8) UNIQUE;
```

## 🎯 비즈니스 로직 구현

### 거래 제한 검증 서비스
```python
# services/TradingLimitService.py
class TradingLimitService:
    """거래 제한 관리 서비스"""
    
    @staticmethod
    def can_make_trade(user_id, trade_type='demo'):
        """거래 가능 여부 확인"""
        user = User.get_by_id(user_id)
        
        # 비회원은 모든 거래 차단
        if not user or not user.is_authenticated:
            return {
                'allowed': False,
                'reason': '로그인이 필요합니다.',
                'redirect_to': '/login'
            }
        
        # 라이프타임/프리미엄 회원은 무제한
        if user.membership_type in ['lifetime', 'premium']:
            return {'allowed': True}
        
        # 무료 회원 제한 로직
        if user.membership_type == 'free':
            # 신규 가입 7일 무료 기간 확인
            if user.is_in_free_trial():
                return {'allowed': True}
            
            # 일일 거래 제한 확인 (매수 1회, 매도 1회)
            today_trades = user.get_today_trade_count()
            if today_trades >= 2:
                return {
                    'allowed': False,
                    'reason': '일일 거래 횟수를 초과했습니다. (2회/일)',
                    'upgrade_suggested': True
                }
            
            # 실전 거래는 차단
            if trade_type == 'real':
                return {
                    'allowed': False,
                    'reason': '실전 거래는 유료 회원만 이용 가능합니다.',
                    'upgrade_required': True
                }
        
        return {'allowed': True}
    
    @staticmethod
    def record_trade(user_id, trade_type):
        """거래 기록"""
        user = User.get_by_id(user_id)
        
        if user.membership_type == 'free':
            # 일일 거래 횟수 증가
            from datetime import date
            today = date.today()
            
            if user.daily_trade_reset_date != today:
                user.daily_trade_count = 0
                user.daily_trade_reset_date = today
            
            user.daily_trade_count += 1
            user.save()
```

## 📱 UI/UX 개선사항

### 회원가입 플로우 개선
```javascript
// SignupFlow.jsx
function SignupFlow() {
  const [referralCode, setReferralCode] = useState('')
  const [step, setStep] = useState(1)
  
  useEffect(() => {
    // URL에서 초대 코드 추출
    const urlParams = new URLSearchParams(window.location.search)
    const refCode = urlParams.get('ref')
    if (refCode) {
      setReferralCode(refCode)
      // 초대 코드 유효성 검증
      validateReferralCode(refCode)
    }
  }, [])
  
  const handleSignup = async (userData) => {
    const signupData = {
      ...userData,
      referral_code: referralCode
    }
    
    const response = await signup(signupData)
    if (response.success) {
      // 신규 가입 혜택 안내
      showWelcomeDialog({
        freeTrialDays: 7,
        hasReferral: !!referralCode
      })
    }
  }
  
  return (
    <Box>
      {referralCode && (
        <Alert severity="success" sx={{ mb: 2 }}>
          🎁 친구 초대로 가입하시는군요! 7일 무료 체험 + 추가 혜택을 드립니다.
        </Alert>
      )}
      {/* 가입 폼 */}
    </Box>
  )
}
```

이제 다음 단계로 이러한 시스템들을 실제로 구현해보겠습니다. 백엔드 서버부터 시작하겠습니다.

<function_calls>
<invoke name="run_terminal_cmd">
<parameter name="command">cd ..
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant:<rewritten_file>
```
# Christmas 프로젝트 - 회원 등급 및 이벤트 시스템 설계

## 📋 개요

사용자 확보와 수익화 최적화를 위한 회원 등급 체계, 친구 초대 시스템, 쿠폰 시스템을 설계합니다.

## 👥 회원 등급 체계 (수정)

### 🚫 비회원 (Guest)
```yaml
접근_권한:
  - 서비스 이용 불가
  - 로그인 페이지만 접근 가능
  - 회원가입 안내 페이지

제한_사항:
  - 모든 기능 차단
  - 데이터 접근 불가
  - 데모 모드도 제공하지 않음
```

### 🆓 무료 회원 (Free Member)
```yaml
기본_혜택:
  - 매일 모의 투자 매매 2회 (매수 1회, 매도 1회)
  - 기본 차트 조회 (제한적)
  - 투자 교육 콘텐츠 (기초 과정만)

신규_가입_혜택:
  - 최초 가입 후 7일간 무제한 모의 매매
  - 7일 후 일일 2회 제한으로 변경
  - 유료 회원 전환 안내

제한_사항:
  - 실전 거래 완전 차단
  - API 연동 불가
  - 고급 분석 도구 제한
  - 텔레그램 알림 제한
  - 백테스팅 불가
```

### 💎 프리미엄 회원 (Premium Member)
```yaml
월_구독_혜택:
  - 요금: $15/월
  - 실전 거래 무제한
  - 매매 수수료: 1%
  - 모든 차트 및 지표 이용
  - 실시간 알림 (텔레그램, 이메일)
  - 백테스팅 기능
  - 포트폴리오 상세 분석
  - 우선 고객 지원

추가_기능:
  - API 키 개인 설정
  - 고급 매매 전략 이용
  - 커뮤니티 전체 접근
  - 월간 투자 리포트
```

### 🏆 라이프타임 회원 (Lifetime Member)
```yaml
일시불_혜택:
  - 요금: ₩10,000,000 (환불 불가)
  - 모든 프리미엄 기능
  - 매매 수수료 완전 면제
  - VIP 전용 기능
  - 개인 맞춤 전략 컨설팅
  - 베타 기능 우선 체험
  - 전용 고객 지원 채널
  - 평생 서비스 보장

특별_혜택:
  - 신규 기능 무료 업그레이드
  - 월간 개인 투자 상담
  - VIP 커뮤니티 접근
  - 연간 오프라인 세미나 참석권
```

## 🎁 친구 초대 시스템

### 초대 코드 생성 시스템
```python
# models/ReferralCode.py
class ReferralCode:
    """친구 초대 코드 모델"""
    
    def __init__(self):
        self.user_id = None          # 초대자 ID
        self.code = None             # 8자리 고유 코드
        self.invite_url = None       # 초대 링크 URL
        self.created_at = None       # 생성 일시
        self.expires_at = None       # 만료 일시 (90일 후)
        self.max_uses = 50           # 최대 사용 횟수
        self.current_uses = 0        # 현재 사용 횟수
        self.is_active = True        # 활성 상태
        
    def generate_code(self, user_id):
        """고유 초대 코드 생성"""
        import random
        import string
        from datetime import datetime, timedelta
        
        # 8자리 영숫자 조합 코드 생성
        self.code = ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=8
        ))
        
        self.user_id = user_id
        self.invite_url = f"https://christmas-trading.com/signup?ref={self.code}"
        self.created_at = datetime.now()
        self.expires_at = datetime.now() + timedelta(days=90)
        
        return self.code
    
    def is_valid(self):
        """코드 유효성 검사"""
        from datetime import datetime
        
        return (
            self.is_active and 
            self.current_uses < self.max_uses and
            datetime.now() < self.expires_at
        )

# models/ReferralReward.py
class ReferralReward:
    """초대 보상 모델"""
    
    def __init__(self):
        self.inviter_id = None       # 초대자 ID
        self.invitee_id = None       # 피초대자 ID
        self.referral_code = None    # 사용된 초대 코드
        self.reward_type = 'free_extension'  # 보상 유형
        self.reward_days = 7         # 보상 일수
        self.created_at = None       # 보상 생성 일시
        self.applied_at = None       # 보상 적용 일시
        self.is_claimed = False      # 보상 수령 여부
        
    def apply_reward(self, inviter_id, invitee_id, code):
        """초대 보상 적용"""
        from datetime import datetime
        
        self.inviter_id = inviter_id
        self.invitee_id = invitee_id
        self.referral_code = code
        self.created_at = datetime.now()
        
        # 초대자에게 7일 연장 혜택 부여
        self.extend_membership(inviter_id, 7)
        self.is_claimed = True
        self.applied_at = datetime.now()
        
    def extend_membership(self, user_id, days):
        """회원권 연장"""
        user = User.get_by_id(user_id)
        current_total_extension = self.get_total_extension_days(user_id)
        
        # 최대 3개월(90일) 제한 확인
        if current_total_extension + days <= 90:
            user.extend_free_period(days)
            return True
        else:
            # 90일 한도 초과시 남은 일수만 연장
            remaining_days = 90 - current_total_extension
            if remaining_days > 0:
                user.extend_free_period(remaining_days)
            return False
```

### 초대 프로세스 플로우
```yaml
초대_프로세스:
  1. 초대자가 초대 코드 생성
  2. 초대 링크를 친구에게 공유
  3. 친구가 링크를 통해 회원가입
  4. 시스템이 초대 관계 확인
  5. 초대자에게 7일 연장 혜택 자동 지급
  6. 피초대자는 신규 가입 혜택 (7일 무료) 제공

제한_사항:
  - 초대자당 최대 연장 기간: 3개월 (90일)
  - 코드 유효 기간: 90일
  - 코드당 최대 사용 횟수: 50회
  - 자가 초대 방지 로직 구현
```

## 🎫 쿠폰 시스템

### 쿠폰 유형 설계
```python
# models/Coupon.py
class Coupon:
    """쿠폰 시스템 모델"""
    
    def __init__(self):
        self.coupon_id = None        # 쿠폰 고유 ID
        self.code = None             # 쿠폰 코드
        self.name = None             # 쿠폰 이름
        self.description = None      # 쿠폰 설명
        self.coupon_type = None      # 쿠폰 유형
        self.discount_type = None    # 할인 유형
        self.discount_value = None   # 할인 값
        self.min_purchase_amount = 0 # 최소 구매 금액
        self.max_discount_amount = None # 최대 할인 금액
        self.usage_limit = None      # 사용 횟수 제한
        self.used_count = 0          # 사용된 횟수
        self.start_date = None       # 시작 일시
        self.end_date = None         # 종료 일시
        self.target_users = []       # 대상 사용자 (빈 배열시 전체)
        self.target_membership = []  # 대상 회원 등급
        self.is_active = True        # 활성 상태
        self.created_by = None       # 생성자 (관리자 ID)
        self.created_at = None       # 생성 일시

# 쿠폰 유형 정의
COUPON_TYPES = {
    'subscription_discount': '구독료 할인',
    'commission_discount': '수수료 할인', 
    'free_trial_extension': '무료 체험 연장',
    'premium_upgrade': '프리미엄 업그레이드',
    'lifetime_discount': '라이프타임 할인'
}

DISCOUNT_TYPES = {
    'percentage': '퍼센트 할인',
    'fixed_amount': '고정 금액 할인',
    'free_period': '무료 기간 제공'
}

class CouponService:
    """쿠폰 서비스 클래스"""
    
    @staticmethod
    def create_coupon(admin_id, coupon_data):
        """관리자 쿠폰 생성"""
        import random
        import string
        from datetime import datetime
        
        coupon = Coupon()
        coupon.code = CouponService.generate_coupon_code()
        coupon.name = coupon_data['name']
        coupon.description = coupon_data['description']
        coupon.coupon_type = coupon_data['coupon_type']
        coupon.discount_type = coupon_data['discount_type']
        coupon.discount_value = coupon_data['discount_value']
        coupon.min_purchase_amount = coupon_data.get('min_purchase_amount', 0)
        coupon.max_discount_amount = coupon_data.get('max_discount_amount')
        coupon.usage_limit = coupon_data.get('usage_limit')
        coupon.start_date = coupon_data['start_date']
        coupon.end_date = coupon_data['end_date']
        coupon.target_users = coupon_data.get('target_users', [])
        coupon.target_membership = coupon_data.get('target_membership', [])
        coupon.created_by = admin_id
        coupon.created_at = datetime.now()
        
        return coupon.save()
    
    @staticmethod
    def generate_coupon_code():
        """쿠폰 코드 생성 (12자리)"""
        return ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=12
        ))
    
    @staticmethod
    def validate_coupon(code, user_id, purchase_amount=0):
        """쿠폰 유효성 검증"""
        from datetime import datetime
        
        coupon = Coupon.get_by_code(code)
        if not coupon:
            return {'valid': False, 'reason': '존재하지 않는 쿠폰입니다.'}
        
        # 활성 상태 확인
        if not coupon.is_active:
            return {'valid': False, 'reason': '비활성화된 쿠폰입니다.'}
        
        # 기간 확인
        now = datetime.now()
        if now < coupon.start_date or now > coupon.end_date:
            return {'valid': False, 'reason': '쿠폰 사용 기간이 아닙니다.'}
        
        # 사용 횟수 확인
        if coupon.usage_limit and coupon.used_count >= coupon.usage_limit:
            return {'valid': False, 'reason': '쿠폰 사용 한도를 초과했습니다.'}
        
        # 대상 사용자 확인
        if coupon.target_users and user_id not in coupon.target_users:
            return {'valid': False, 'reason': '쿠폰 사용 대상이 아닙니다.'}
        
        # 최소 구매 금액 확인
        if purchase_amount < coupon.min_purchase_amount:
            return {'valid': False, 'reason': f'최소 구매 금액 {coupon.min_purchase_amount:,}원 이상이어야 합니다.'}
        
        # 회원 등급 확인
        user = User.get_by_id(user_id)
        if coupon.target_membership and user.membership_type not in coupon.target_membership:
            return {'valid': False, 'reason': '해당 회원 등급은 쿠폰을 사용할 수 없습니다.'}
        
        return {'valid': True, 'coupon': coupon}
    
    @staticmethod
    def apply_coupon(coupon, user_id, purchase_amount):
        """쿠폰 적용"""
        discount_amount = 0
        
        if coupon.discount_type == 'percentage':
            discount_amount = purchase_amount * (coupon.discount_value / 100)
            if coupon.max_discount_amount:
                discount_amount = min(discount_amount, coupon.max_discount_amount)
                
        elif coupon.discount_type == 'fixed_amount':
            discount_amount = coupon.discount_value
            
        elif coupon.discount_type == 'free_period':
            # 무료 기간 제공 로직
            user = User.get_by_id(user_id)
            user.extend_free_period(coupon.discount_value)
            discount_amount = purchase_amount  # 전액 할인
        
        # 쿠폰 사용 기록
        coupon.used_count += 1
        coupon.save()
        
        # 사용 이력 저장
        CouponUsage.create({
            'coupon_id': coupon.coupon_id,
            'user_id': user_id,
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount,
            'used_at': datetime.now()
        })
        
        return {
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount
        }
```

### 관리자 쿠폰 관리 페이지
```javascript
// AdminCouponManager.jsx
import React, { useState, useEffect } from 'react'
import {
  Box, Card, CardContent, Typography, Button, Dialog,
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  TextField, Select, MenuItem, FormControl, InputLabel,
  Chip, Grid, Alert, IconButton
} from '@mui/material'
import {
  Add, Edit, Delete, Visibility, GetApp
} from '@mui/icons-material'

function AdminCouponManager() {
  const [coupons, setCoupons] = useState([])
  const [createDialog, setCreateDialog] = useState(false)
  const [newCoupon, setNewCoupon] = useState({
    name: '',
    description: '',
    coupon_type: 'subscription_discount',
    discount_type: 'percentage',
    discount_value: '',
    min_purchase_amount: 0,
    max_discount_amount: '',
    usage_limit: '',
    start_date: '',
    end_date: '',
    target_membership: []
  })

  const handleCreateCoupon = async () => {
    try {
      const response = await fetch('/api/admin/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCoupon)
      })
      
      if (response.ok) {
        const createdCoupon = await response.json()
        setCoupons([...coupons, createdCoupon])
        setCreateDialog(false)
        setNewCoupon({})
      }
    } catch (error) {
      console.error('쿠폰 생성 실패:', error)
    }
  }

  const getCouponStatusColor = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return 'error'
    if (now < startDate) return 'warning'
    if (now > endDate) return 'default'
    return 'success'
  }

  const getCouponStatusText = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return '비활성'
    if (now < startDate) return '대기중'
    if (now > endDate) return '만료됨'
    return '활성'
  }

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h5">🎫 쿠폰 관리</Typography>
        <Button
          variant="contained"
          startIcon={<Add />}
          onClick={() => setCreateDialog(true)}
        >
          쿠폰 생성
        </Button>
      </Box>

      {/* 쿠폰 통계 */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="primary">
                {coupons.filter(c => c.is_active).length}
              </Typography>
              <Typography variant="body2">활성 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="success.main">
                {coupons.reduce((sum, c) => sum + c.used_count, 0)}
              </Typography>
              <Typography variant="body2">총 사용 횟수</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="warning.main">
                {coupons.filter(c => new Date() < new Date(c.start_date)).length}
              </Typography>
              <Typography variant="body2">예약된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="error.main">
                {coupons.filter(c => new Date() > new Date(c.end_date)).length}
              </Typography>
              <Typography variant="body2">만료된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* 쿠폰 목록 */}
      <Card>
        <CardContent>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>쿠폰명</TableCell>
                  <TableCell>코드</TableCell>
                  <TableCell>유형</TableCell>
                  <TableCell>할인값</TableCell>
                  <TableCell>사용횟수</TableCell>
                  <TableCell>기간</TableCell>
                  <TableCell>상태</TableCell>
                  <TableCell>관리</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {coupons.map((coupon) => (
                  <TableRow key={coupon.coupon_id}>
                    <TableCell>
                      <Typography variant="body2" fontWeight="bold">
                        {coupon.name}
                      </Typography>
                      <Typography variant="caption" color="textSecondary">
                        {coupon.description}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" fontFamily="monospace">
                        {coupon.code}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {coupon.coupon_type}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {coupon.discount_type === 'percentage' 
                        ? `${coupon.discount_value}%`
                        : `${coupon.discount_value:,}원`}
                    </TableCell>
                    <TableCell>
                      {coupon.used_count} / {coupon.usage_limit || '무제한'}
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {new Date(coupon.start_date).toLocaleDateString()} ~<br/>
                        {new Date(coupon.end_date).toLocaleDateString()}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Chip 
                        label={getCouponStatusText(coupon)}
                        color={getCouponStatusColor(coupon)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell>
                      <IconButton size="small">
                        <Visibility />
                      </IconButton>
                      <IconButton size="small">
                        <Edit />
                      </IconButton>
                      <IconButton size="small" color="error">
                        <Delete />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </CardContent>
      </Card>

      {/* 쿠폰 생성 다이얼로그 */}
      <Dialog 
        open={createDialog} 
        onClose={() => setCreateDialog(false)}
        maxWidth="md"
        fullWidth
      >
        {/* 쿠폰 생성 폼 구현 */}
      </Dialog>
    </Box>
  )
}

export default AdminCouponManager
```

## 🔄 구현 우선순위

### Phase 2A-Extended: 회원 시스템 고도화 (D+1 ~ D+21)

#### Week 1: 회원 등급 시스템 수정
```powershell
# 1. 회원 모델 업데이트
# User 모델에 새로운 필드 추가
- free_trial_end_date    # 무료 체험 종료일
- daily_trade_count      # 일일 거래 횟수
- total_extension_days   # 총 연장 일수
- referral_code          # 개인 초대 코드

# 2. 거래 제한 로직 구현
# TradeController에서 회원 등급별 제한 체크
```

#### Week 2: 친구 초대 시스템
```powershell
# 1. 초대 코드 생성 기능
# ReferralCode 모델 및 서비스 구현

# 2. 초대 링크 처리
# 회원가입 시 초대 코드 확인 로직

# 3. 보상 지급 시스템
# 자동 연장 및 한도 관리
```

#### Week 3: 쿠폰 시스템
```powershell
# 1. 쿠폰 모델 및 서비스 구현
# Coupon, CouponUsage 모델 생성

# 2. 관리자 쿠폰 관리 페이지
# AdminCouponManager 컴포넌트 구현

# 3. 쿠폰 적용 로직
# 결제 시스템과 연동
```

## 📊 데이터베이스 스키마 설계

### 새로운 테이블 구조
```sql
-- 초대 코드 테이블
CREATE TABLE referral_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    code VARCHAR(8) UNIQUE NOT NULL,
    invite_url VARCHAR(255) NOT NULL,
    max_uses INT DEFAULT 50,
    current_uses INT DEFAULT 0,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 초대 보상 테이블
CREATE TABLE referral_rewards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    inviter_id BIGINT NOT NULL,
    invitee_id BIGINT NOT NULL,
    referral_code VARCHAR(8) NOT NULL,
    reward_days INT DEFAULT 7,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_at TIMESTAMP,
    is_claimed BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (inviter_id) REFERENCES users(id),
    FOREIGN KEY (invitee_id) REFERENCES users(id)
);

-- 쿠폰 테이블
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(12) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    coupon_type ENUM('subscription_discount', 'commission_discount', 'free_trial_extension', 'premium_upgrade', 'lifetime_discount') NOT NULL,
    discount_type ENUM('percentage', 'fixed_amount', 'free_period') NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_purchase_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INT,
    used_count INT DEFAULT 0,
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    target_membership JSON,
    target_users JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 쿠폰 사용 이력 테이블
CREATE TABLE coupon_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coupon_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    final_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 사용자 테이블 수정 (새 컬럼 추가)
ALTER TABLE users ADD COLUMN free_trial_end_date DATETIME;
ALTER TABLE users ADD COLUMN daily_trade_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN daily_trade_reset_date DATE;
ALTER TABLE users ADD COLUMN total_extension_days INT DEFAULT 0;
ALTER TABLE users ADD COLUMN personal_referral_code VARCHAR(8) UNIQUE;
```

## 🎯 비즈니스 로직 구현

### 거래 제한 검증 서비스
```python
# services/TradingLimitService.py
class TradingLimitService:
    """거래 제한 관리 서비스"""
    
    @staticmethod
    def can_make_trade(user_id, trade_type='demo'):
        """거래 가능 여부 확인"""
        user = User.get_by_id(user_id)
        
        # 비회원은 모든 거래 차단
        if not user or not user.is_authenticated:
            return {
                'allowed': False,
                'reason': '로그인이 필요합니다.',
                'redirect_to': '/login'
            }
        
        # 라이프타임/프리미엄 회원은 무제한
        if user.membership_type in ['lifetime', 'premium']:
            return {'allowed': True}
        
        # 무료 회원 제한 로직
        if user.membership_type == 'free':
            # 신규 가입 7일 무료 기간 확인
            if user.is_in_free_trial():
                return {'allowed': True}
            
            # 일일 거래 제한 확인 (매수 1회, 매도 1회)
            today_trades = user.get_today_trade_count()
            if today_trades >= 2:
                return {
                    'allowed': False,
                    'reason': '일일 거래 횟수를 초과했습니다. (2회/일)',
                    'upgrade_suggested': True
                }
            
            # 실전 거래는 차단
            if trade_type == 'real':
                return {
                    'allowed': False,
                    'reason': '실전 거래는 유료 회원만 이용 가능합니다.',
                    'upgrade_required': True
                }
        
        return {'allowed': True}
    
    @staticmethod
    def record_trade(user_id, trade_type):
        """거래 기록"""
        user = User.get_by_id(user_id)
        
        if user.membership_type == 'free':
            # 일일 거래 횟수 증가
            from datetime import date
            today = date.today()
            
            if user.daily_trade_reset_date != today:
                user.daily_trade_count = 0
                user.daily_trade_reset_date = today
            
            user.daily_trade_count += 1
            user.save()
```

## 📱 UI/UX 개선사항

### 회원가입 플로우 개선
```javascript
// SignupFlow.jsx
function SignupFlow() {
  const [referralCode, setReferralCode] = useState('')
  const [step, setStep] = useState(1)
  
  useEffect(() => {
    // URL에서 초대 코드 추출
    const urlParams = new URLSearchParams(window.location.search)
    const refCode = urlParams.get('ref')
    if (refCode) {
      setReferralCode(refCode)
      // 초대 코드 유효성 검증
      validateReferralCode(refCode)
    }
  }, [])
  
  const handleSignup = async (userData) => {
    const signupData = {
      ...userData,
      referral_code: referralCode
    }
    
    const response = await signup(signupData)
    if (response.success) {
      // 신규 가입 혜택 안내
      showWelcomeDialog({
        freeTrialDays: 7,
        hasReferral: !!referralCode
      })
    }
  }
  
  return (
    <Box>
      {referralCode && (
        <Alert severity="success" sx={{ mb: 2 }}>
          🎁 친구 초대로 가입하시는군요! 7일 무료 체험 + 추가 혜택을 드립니다.
        </Alert>
      )}
      {/* 가입 폼 */}
    </Box>
  )
}
```

이제 다음 단계로 이러한 시스템들을 실제로 구현해보겠습니다. 백엔드 서버부터 시작하겠습니다.

<function_calls>
<invoke name="run_terminal_cmd">
<parameter name="command">cd ..
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant:<rewritten_file>
```
# Christmas 프로젝트 - 회원 등급 및 이벤트 시스템 설계

## 📋 개요

사용자 확보와 수익화 최적화를 위한 회원 등급 체계, 친구 초대 시스템, 쿠폰 시스템을 설계합니다.

## 👥 회원 등급 체계 (수정)

### 🚫 비회원 (Guest)
```yaml
접근_권한:
  - 서비스 이용 불가
  - 로그인 페이지만 접근 가능
  - 회원가입 안내 페이지

제한_사항:
  - 모든 기능 차단
  - 데이터 접근 불가
  - 데모 모드도 제공하지 않음
```

### 🆓 무료 회원 (Free Member)
```yaml
기본_혜택:
  - 매일 모의 투자 매매 2회 (매수 1회, 매도 1회)
  - 기본 차트 조회 (제한적)
  - 투자 교육 콘텐츠 (기초 과정만)

신규_가입_혜택:
  - 최초 가입 후 7일간 무제한 모의 매매
  - 7일 후 일일 2회 제한으로 변경
  - 유료 회원 전환 안내

제한_사항:
  - 실전 거래 완전 차단
  - API 연동 불가
  - 고급 분석 도구 제한
  - 텔레그램 알림 제한
  - 백테스팅 불가
```

### 💎 프리미엄 회원 (Premium Member)
```yaml
월_구독_혜택:
  - 요금: $15/월
  - 실전 거래 무제한
  - 매매 수수료: 1%
  - 모든 차트 및 지표 이용
  - 실시간 알림 (텔레그램, 이메일)
  - 백테스팅 기능
  - 포트폴리오 상세 분석
  - 우선 고객 지원

추가_기능:
  - API 키 개인 설정
  - 고급 매매 전략 이용
  - 커뮤니티 전체 접근
  - 월간 투자 리포트
```

### 🏆 라이프타임 회원 (Lifetime Member)
```yaml
일시불_혜택:
  - 요금: ₩10,000,000 (환불 불가)
  - 모든 프리미엄 기능
  - 매매 수수료 완전 면제
  - VIP 전용 기능
  - 개인 맞춤 전략 컨설팅
  - 베타 기능 우선 체험
  - 전용 고객 지원 채널
  - 평생 서비스 보장

특별_혜택:
  - 신규 기능 무료 업그레이드
  - 월간 개인 투자 상담
  - VIP 커뮤니티 접근
  - 연간 오프라인 세미나 참석권
```

## 🎁 친구 초대 시스템

### 초대 코드 생성 시스템
```python
# models/ReferralCode.py
class ReferralCode:
    """친구 초대 코드 모델"""
    
    def __init__(self):
        self.user_id = None          # 초대자 ID
        self.code = None             # 8자리 고유 코드
        self.invite_url = None       # 초대 링크 URL
        self.created_at = None       # 생성 일시
        self.expires_at = None       # 만료 일시 (90일 후)
        self.max_uses = 50           # 최대 사용 횟수
        self.current_uses = 0        # 현재 사용 횟수
        self.is_active = True        # 활성 상태
        
    def generate_code(self, user_id):
        """고유 초대 코드 생성"""
        import random
        import string
        from datetime import datetime, timedelta
        
        # 8자리 영숫자 조합 코드 생성
        self.code = ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=8
        ))
        
        self.user_id = user_id
        self.invite_url = f"https://christmas-trading.com/signup?ref={self.code}"
        self.created_at = datetime.now()
        self.expires_at = datetime.now() + timedelta(days=90)
        
        return self.code
    
    def is_valid(self):
        """코드 유효성 검사"""
        from datetime import datetime
        
        return (
            self.is_active and 
            self.current_uses < self.max_uses and
            datetime.now() < self.expires_at
        )

# models/ReferralReward.py
class ReferralReward:
    """초대 보상 모델"""
    
    def __init__(self):
        self.inviter_id = None       # 초대자 ID
        self.invitee_id = None       # 피초대자 ID
        self.referral_code = None    # 사용된 초대 코드
        self.reward_type = 'free_extension'  # 보상 유형
        self.reward_days = 7         # 보상 일수
        self.created_at = None       # 보상 생성 일시
        self.applied_at = None       # 보상 적용 일시
        self.is_claimed = False      # 보상 수령 여부
        
    def apply_reward(self, inviter_id, invitee_id, code):
        """초대 보상 적용"""
        from datetime import datetime
        
        self.inviter_id = inviter_id
        self.invitee_id = invitee_id
        self.referral_code = code
        self.created_at = datetime.now()
        
        # 초대자에게 7일 연장 혜택 부여
        self.extend_membership(inviter_id, 7)
        self.is_claimed = True
        self.applied_at = datetime.now()
        
    def extend_membership(self, user_id, days):
        """회원권 연장"""
        user = User.get_by_id(user_id)
        current_total_extension = self.get_total_extension_days(user_id)
        
        # 최대 3개월(90일) 제한 확인
        if current_total_extension + days <= 90:
            user.extend_free_period(days)
            return True
        else:
            # 90일 한도 초과시 남은 일수만 연장
            remaining_days = 90 - current_total_extension
            if remaining_days > 0:
                user.extend_free_period(remaining_days)
            return False
```

### 초대 프로세스 플로우
```yaml
초대_프로세스:
  1. 초대자가 초대 코드 생성
  2. 초대 링크를 친구에게 공유
  3. 친구가 링크를 통해 회원가입
  4. 시스템이 초대 관계 확인
  5. 초대자에게 7일 연장 혜택 자동 지급
  6. 피초대자는 신규 가입 혜택 (7일 무료) 제공

제한_사항:
  - 초대자당 최대 연장 기간: 3개월 (90일)
  - 코드 유효 기간: 90일
  - 코드당 최대 사용 횟수: 50회
  - 자가 초대 방지 로직 구현
```

## 🎫 쿠폰 시스템

### 쿠폰 유형 설계
```python
# models/Coupon.py
class Coupon:
    """쿠폰 시스템 모델"""
    
    def __init__(self):
        self.coupon_id = None        # 쿠폰 고유 ID
        self.code = None             # 쿠폰 코드
        self.name = None             # 쿠폰 이름
        self.description = None      # 쿠폰 설명
        self.coupon_type = None      # 쿠폰 유형
        self.discount_type = None    # 할인 유형
        self.discount_value = None   # 할인 값
        self.min_purchase_amount = 0 # 최소 구매 금액
        self.max_discount_amount = None # 최대 할인 금액
        self.usage_limit = None      # 사용 횟수 제한
        self.used_count = 0          # 사용된 횟수
        self.start_date = None       # 시작 일시
        self.end_date = None         # 종료 일시
        self.target_users = []       # 대상 사용자 (빈 배열시 전체)
        self.target_membership = []  # 대상 회원 등급
        self.is_active = True        # 활성 상태
        self.created_by = None       # 생성자 (관리자 ID)
        self.created_at = None       # 생성 일시

# 쿠폰 유형 정의
COUPON_TYPES = {
    'subscription_discount': '구독료 할인',
    'commission_discount': '수수료 할인', 
    'free_trial_extension': '무료 체험 연장',
    'premium_upgrade': '프리미엄 업그레이드',
    'lifetime_discount': '라이프타임 할인'
}

DISCOUNT_TYPES = {
    'percentage': '퍼센트 할인',
    'fixed_amount': '고정 금액 할인',
    'free_period': '무료 기간 제공'
}

class CouponService:
    """쿠폰 서비스 클래스"""
    
    @staticmethod
    def create_coupon(admin_id, coupon_data):
        """관리자 쿠폰 생성"""
        import random
        import string
        from datetime import datetime
        
        coupon = Coupon()
        coupon.code = CouponService.generate_coupon_code()
        coupon.name = coupon_data['name']
        coupon.description = coupon_data['description']
        coupon.coupon_type = coupon_data['coupon_type']
        coupon.discount_type = coupon_data['discount_type']
        coupon.discount_value = coupon_data['discount_value']
        coupon.min_purchase_amount = coupon_data.get('min_purchase_amount', 0)
        coupon.max_discount_amount = coupon_data.get('max_discount_amount')
        coupon.usage_limit = coupon_data.get('usage_limit')
        coupon.start_date = coupon_data['start_date']
        coupon.end_date = coupon_data['end_date']
        coupon.target_users = coupon_data.get('target_users', [])
        coupon.target_membership = coupon_data.get('target_membership', [])
        coupon.created_by = admin_id
        coupon.created_at = datetime.now()
        
        return coupon.save()
    
    @staticmethod
    def generate_coupon_code():
        """쿠폰 코드 생성 (12자리)"""
        return ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=12
        ))
    
    @staticmethod
    def validate_coupon(code, user_id, purchase_amount=0):
        """쿠폰 유효성 검증"""
        from datetime import datetime
        
        coupon = Coupon.get_by_code(code)
        if not coupon:
            return {'valid': False, 'reason': '존재하지 않는 쿠폰입니다.'}
        
        # 활성 상태 확인
        if not coupon.is_active:
            return {'valid': False, 'reason': '비활성화된 쿠폰입니다.'}
        
        # 기간 확인
        now = datetime.now()
        if now < coupon.start_date or now > coupon.end_date:
            return {'valid': False, 'reason': '쿠폰 사용 기간이 아닙니다.'}
        
        # 사용 횟수 확인
        if coupon.usage_limit and coupon.used_count >= coupon.usage_limit:
            return {'valid': False, 'reason': '쿠폰 사용 한도를 초과했습니다.'}
        
        # 대상 사용자 확인
        if coupon.target_users and user_id not in coupon.target_users:
            return {'valid': False, 'reason': '쿠폰 사용 대상이 아닙니다.'}
        
        # 최소 구매 금액 확인
        if purchase_amount < coupon.min_purchase_amount:
            return {'valid': False, 'reason': f'최소 구매 금액 {coupon.min_purchase_amount:,}원 이상이어야 합니다.'}
        
        # 회원 등급 확인
        user = User.get_by_id(user_id)
        if coupon.target_membership and user.membership_type not in coupon.target_membership:
            return {'valid': False, 'reason': '해당 회원 등급은 쿠폰을 사용할 수 없습니다.'}
        
        return {'valid': True, 'coupon': coupon}
    
    @staticmethod
    def apply_coupon(coupon, user_id, purchase_amount):
        """쿠폰 적용"""
        discount_amount = 0
        
        if coupon.discount_type == 'percentage':
            discount_amount = purchase_amount * (coupon.discount_value / 100)
            if coupon.max_discount_amount:
                discount_amount = min(discount_amount, coupon.max_discount_amount)
                
        elif coupon.discount_type == 'fixed_amount':
            discount_amount = coupon.discount_value
            
        elif coupon.discount_type == 'free_period':
            # 무료 기간 제공 로직
            user = User.get_by_id(user_id)
            user.extend_free_period(coupon.discount_value)
            discount_amount = purchase_amount  # 전액 할인
        
        # 쿠폰 사용 기록
        coupon.used_count += 1
        coupon.save()
        
        # 사용 이력 저장
        CouponUsage.create({
            'coupon_id': coupon.coupon_id,
            'user_id': user_id,
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount,
            'used_at': datetime.now()
        })
        
        return {
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount
        }
```

### 관리자 쿠폰 관리 페이지
```javascript
// AdminCouponManager.jsx
import React, { useState, useEffect } from 'react'
import {
  Box, Card, CardContent, Typography, Button, Dialog,
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  TextField, Select, MenuItem, FormControl, InputLabel,
  Chip, Grid, Alert, IconButton
} from '@mui/material'
import {
  Add, Edit, Delete, Visibility, GetApp
} from '@mui/icons-material'

function AdminCouponManager() {
  const [coupons, setCoupons] = useState([])
  const [createDialog, setCreateDialog] = useState(false)
  const [newCoupon, setNewCoupon] = useState({
    name: '',
    description: '',
    coupon_type: 'subscription_discount',
    discount_type: 'percentage',
    discount_value: '',
    min_purchase_amount: 0,
    max_discount_amount: '',
    usage_limit: '',
    start_date: '',
    end_date: '',
    target_membership: []
  })

  const handleCreateCoupon = async () => {
    try {
      const response = await fetch('/api/admin/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCoupon)
      })
      
      if (response.ok) {
        const createdCoupon = await response.json()
        setCoupons([...coupons, createdCoupon])
        setCreateDialog(false)
        setNewCoupon({})
      }
    } catch (error) {
      console.error('쿠폰 생성 실패:', error)
    }
  }

  const getCouponStatusColor = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return 'error'
    if (now < startDate) return 'warning'
    if (now > endDate) return 'default'
    return 'success'
  }

  const getCouponStatusText = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return '비활성'
    if (now < startDate) return '대기중'
    if (now > endDate) return '만료됨'
    return '활성'
  }

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h5">🎫 쿠폰 관리</Typography>
        <Button
          variant="contained"
          startIcon={<Add />}
          onClick={() => setCreateDialog(true)}
        >
          쿠폰 생성
        </Button>
      </Box>

      {/* 쿠폰 통계 */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="primary">
                {coupons.filter(c => c.is_active).length}
              </Typography>
              <Typography variant="body2">활성 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="success.main">
                {coupons.reduce((sum, c) => sum + c.used_count, 0)}
              </Typography>
              <Typography variant="body2">총 사용 횟수</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="warning.main">
                {coupons.filter(c => new Date() < new Date(c.start_date)).length}
              </Typography>
              <Typography variant="body2">예약된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="error.main">
                {coupons.filter(c => new Date() > new Date(c.end_date)).length}
              </Typography>
              <Typography variant="body2">만료된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* 쿠폰 목록 */}
      <Card>
        <CardContent>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>쿠폰명</TableCell>
                  <TableCell>코드</TableCell>
                  <TableCell>유형</TableCell>
                  <TableCell>할인값</TableCell>
                  <TableCell>사용횟수</TableCell>
                  <TableCell>기간</TableCell>
                  <TableCell>상태</TableCell>
                  <TableCell>관리</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {coupons.map((coupon) => (
                  <TableRow key={coupon.coupon_id}>
                    <TableCell>
                      <Typography variant="body2" fontWeight="bold">
                        {coupon.name}
                      </Typography>
                      <Typography variant="caption" color="textSecondary">
                        {coupon.description}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" fontFamily="monospace">
                        {coupon.code}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {coupon.coupon_type}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {coupon.discount_type === 'percentage' 
                        ? `${coupon.discount_value}%`
                        : `${coupon.discount_value:,}원`}
                    </TableCell>
                    <TableCell>
                      {coupon.used_count} / {coupon.usage_limit || '무제한'}
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {new Date(coupon.start_date).toLocaleDateString()} ~<br/>
                        {new Date(coupon.end_date).toLocaleDateString()}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Chip 
                        label={getCouponStatusText(coupon)}
                        color={getCouponStatusColor(coupon)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell>
                      <IconButton size="small">
                        <Visibility />
                      </IconButton>
                      <IconButton size="small">
                        <Edit />
                      </IconButton>
                      <IconButton size="small" color="error">
                        <Delete />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </CardContent>
      </Card>

      {/* 쿠폰 생성 다이얼로그 */}
      <Dialog 
        open={createDialog} 
        onClose={() => setCreateDialog(false)}
        maxWidth="md"
        fullWidth
      >
        {/* 쿠폰 생성 폼 구현 */}
      </Dialog>
    </Box>
  )
}

export default AdminCouponManager
```

## 🔄 구현 우선순위

### Phase 2A-Extended: 회원 시스템 고도화 (D+1 ~ D+21)

#### Week 1: 회원 등급 시스템 수정
```powershell
# 1. 회원 모델 업데이트
# User 모델에 새로운 필드 추가
- free_trial_end_date    # 무료 체험 종료일
- daily_trade_count      # 일일 거래 횟수
- total_extension_days   # 총 연장 일수
- referral_code          # 개인 초대 코드

# 2. 거래 제한 로직 구현
# TradeController에서 회원 등급별 제한 체크
```

#### Week 2: 친구 초대 시스템
```powershell
# 1. 초대 코드 생성 기능
# ReferralCode 모델 및 서비스 구현

# 2. 초대 링크 처리
# 회원가입 시 초대 코드 확인 로직

# 3. 보상 지급 시스템
# 자동 연장 및 한도 관리
```

#### Week 3: 쿠폰 시스템
```powershell
# 1. 쿠폰 모델 및 서비스 구현
# Coupon, CouponUsage 모델 생성

# 2. 관리자 쿠폰 관리 페이지
# AdminCouponManager 컴포넌트 구현

# 3. 쿠폰 적용 로직
# 결제 시스템과 연동
```

## 📊 데이터베이스 스키마 설계

### 새로운 테이블 구조
```sql
-- 초대 코드 테이블
CREATE TABLE referral_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    code VARCHAR(8) UNIQUE NOT NULL,
    invite_url VARCHAR(255) NOT NULL,
    max_uses INT DEFAULT 50,
    current_uses INT DEFAULT 0,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 초대 보상 테이블
CREATE TABLE referral_rewards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    inviter_id BIGINT NOT NULL,
    invitee_id BIGINT NOT NULL,
    referral_code VARCHAR(8) NOT NULL,
    reward_days INT DEFAULT 7,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_at TIMESTAMP,
    is_claimed BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (inviter_id) REFERENCES users(id),
    FOREIGN KEY (invitee_id) REFERENCES users(id)
);

-- 쿠폰 테이블
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(12) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    coupon_type ENUM('subscription_discount', 'commission_discount', 'free_trial_extension', 'premium_upgrade', 'lifetime_discount') NOT NULL,
    discount_type ENUM('percentage', 'fixed_amount', 'free_period') NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_purchase_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INT,
    used_count INT DEFAULT 0,
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    target_membership JSON,
    target_users JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 쿠폰 사용 이력 테이블
CREATE TABLE coupon_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coupon_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    final_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 사용자 테이블 수정 (새 컬럼 추가)
ALTER TABLE users ADD COLUMN free_trial_end_date DATETIME;
ALTER TABLE users ADD COLUMN daily_trade_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN daily_trade_reset_date DATE;
ALTER TABLE users ADD COLUMN total_extension_days INT DEFAULT 0;
ALTER TABLE users ADD COLUMN personal_referral_code VARCHAR(8) UNIQUE;
```

## 🎯 비즈니스 로직 구현

### 거래 제한 검증 서비스
```python
# services/TradingLimitService.py
class TradingLimitService:
    """거래 제한 관리 서비스"""
    
    @staticmethod
    def can_make_trade(user_id, trade_type='demo'):
        """거래 가능 여부 확인"""
        user = User.get_by_id(user_id)
        
        # 비회원은 모든 거래 차단
        if not user or not user.is_authenticated:
            return {
                'allowed': False,
                'reason': '로그인이 필요합니다.',
                'redirect_to': '/login'
            }
        
        # 라이프타임/프리미엄 회원은 무제한
        if user.membership_type in ['lifetime', 'premium']:
            return {'allowed': True}
        
        # 무료 회원 제한 로직
        if user.membership_type == 'free':
            # 신규 가입 7일 무료 기간 확인
            if user.is_in_free_trial():
                return {'allowed': True}
            
            # 일일 거래 제한 확인 (매수 1회, 매도 1회)
            today_trades = user.get_today_trade_count()
            if today_trades >= 2:
                return {
                    'allowed': False,
                    'reason': '일일 거래 횟수를 초과했습니다. (2회/일)',
                    'upgrade_suggested': True
                }
            
            # 실전 거래는 차단
            if trade_type == 'real':
                return {
                    'allowed': False,
                    'reason': '실전 거래는 유료 회원만 이용 가능합니다.',
                    'upgrade_required': True
                }
        
        return {'allowed': True}
    
    @staticmethod
    def record_trade(user_id, trade_type):
        """거래 기록"""
        user = User.get_by_id(user_id)
        
        if user.membership_type == 'free':
            # 일일 거래 횟수 증가
            from datetime import date
            today = date.today()
            
            if user.daily_trade_reset_date != today:
                user.daily_trade_count = 0
                user.daily_trade_reset_date = today
            
            user.daily_trade_count += 1
            user.save()
```

## 📱 UI/UX 개선사항

### 회원가입 플로우 개선
```javascript
// SignupFlow.jsx
function SignupFlow() {
  const [referralCode, setReferralCode] = useState('')
  const [step, setStep] = useState(1)
  
  useEffect(() => {
    // URL에서 초대 코드 추출
    const urlParams = new URLSearchParams(window.location.search)
    const refCode = urlParams.get('ref')
    if (refCode) {
      setReferralCode(refCode)
      // 초대 코드 유효성 검증
      validateReferralCode(refCode)
    }
  }, [])
  
  const handleSignup = async (userData) => {
    const signupData = {
      ...userData,
      referral_code: referralCode
    }
    
    const response = await signup(signupData)
    if (response.success) {
      // 신규 가입 혜택 안내
      showWelcomeDialog({
        freeTrialDays: 7,
        hasReferral: !!referralCode
      })
    }
  }
  
  return (
    <Box>
      {referralCode && (
        <Alert severity="success" sx={{ mb: 2 }}>
          🎁 친구 초대로 가입하시는군요! 7일 무료 체험 + 추가 혜택을 드립니다.
        </Alert>
      )}
      {/* 가입 폼 */}
    </Box>
  )
}
```

이제 다음 단계로 이러한 시스템들을 실제로 구현해보겠습니다. 백엔드 서버부터 시작하겠습니다.

<function_calls>
<invoke name="run_terminal_cmd">
<parameter name="command">cd ..
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant:<rewritten_file>
```
# Christmas 프로젝트 - 회원 등급 및 이벤트 시스템 설계

## 📋 개요

사용자 확보와 수익화 최적화를 위한 회원 등급 체계, 친구 초대 시스템, 쿠폰 시스템을 설계합니다.

## 👥 회원 등급 체계 (수정)

### 🚫 비회원 (Guest)
```yaml
접근_권한:
  - 서비스 이용 불가
  - 로그인 페이지만 접근 가능
  - 회원가입 안내 페이지

제한_사항:
  - 모든 기능 차단
  - 데이터 접근 불가
  - 데모 모드도 제공하지 않음
```

### 🆓 무료 회원 (Free Member)
```yaml
기본_혜택:
  - 매일 모의 투자 매매 2회 (매수 1회, 매도 1회)
  - 기본 차트 조회 (제한적)
  - 투자 교육 콘텐츠 (기초 과정만)

신규_가입_혜택:
  - 최초 가입 후 7일간 무제한 모의 매매
  - 7일 후 일일 2회 제한으로 변경
  - 유료 회원 전환 안내

제한_사항:
  - 실전 거래 완전 차단
  - API 연동 불가
  - 고급 분석 도구 제한
  - 텔레그램 알림 제한
  - 백테스팅 불가
```

### 💎 프리미엄 회원 (Premium Member)
```yaml
월_구독_혜택:
  - 요금: $15/월
  - 실전 거래 무제한
  - 매매 수수료: 1%
  - 모든 차트 및 지표 이용
  - 실시간 알림 (텔레그램, 이메일)
  - 백테스팅 기능
  - 포트폴리오 상세 분석
  - 우선 고객 지원

추가_기능:
  - API 키 개인 설정
  - 고급 매매 전략 이용
  - 커뮤니티 전체 접근
  - 월간 투자 리포트
```

### 🏆 라이프타임 회원 (Lifetime Member)
```yaml
일시불_혜택:
  - 요금: ₩10,000,000 (환불 불가)
  - 모든 프리미엄 기능
  - 매매 수수료 완전 면제
  - VIP 전용 기능
  - 개인 맞춤 전략 컨설팅
  - 베타 기능 우선 체험
  - 전용 고객 지원 채널
  - 평생 서비스 보장

특별_혜택:
  - 신규 기능 무료 업그레이드
  - 월간 개인 투자 상담
  - VIP 커뮤니티 접근
  - 연간 오프라인 세미나 참석권
```

## 🎁 친구 초대 시스템

### 초대 코드 생성 시스템
```python
# models/ReferralCode.py
class ReferralCode:
    """친구 초대 코드 모델"""
    
    def __init__(self):
        self.user_id = None          # 초대자 ID
        self.code = None             # 8자리 고유 코드
        self.invite_url = None       # 초대 링크 URL
        self.created_at = None       # 생성 일시
        self.expires_at = None       # 만료 일시 (90일 후)
        self.max_uses = 50           # 최대 사용 횟수
        self.current_uses = 0        # 현재 사용 횟수
        self.is_active = True        # 활성 상태
        
    def generate_code(self, user_id):
        """고유 초대 코드 생성"""
        import random
        import string
        from datetime import datetime, timedelta
        
        # 8자리 영숫자 조합 코드 생성
        self.code = ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=8
        ))
        
        self.user_id = user_id
        self.invite_url = f"https://christmas-trading.com/signup?ref={self.code}"
        self.created_at = datetime.now()
        self.expires_at = datetime.now() + timedelta(days=90)
        
        return self.code
    
    def is_valid(self):
        """코드 유효성 검사"""
        from datetime import datetime
        
        return (
            self.is_active and 
            self.current_uses < self.max_uses and
            datetime.now() < self.expires_at
        )

# models/ReferralReward.py
class ReferralReward:
    """초대 보상 모델"""
    
    def __init__(self):
        self.inviter_id = None       # 초대자 ID
        self.invitee_id = None       # 피초대자 ID
        self.referral_code = None    # 사용된 초대 코드
        self.reward_type = 'free_extension'  # 보상 유형
        self.reward_days = 7         # 보상 일수
        self.created_at = None       # 보상 생성 일시
        self.applied_at = None       # 보상 적용 일시
        self.is_claimed = False      # 보상 수령 여부
        
    def apply_reward(self, inviter_id, invitee_id, code):
        """초대 보상 적용"""
        from datetime import datetime
        
        self.inviter_id = inviter_id
        self.invitee_id = invitee_id
        self.referral_code = code
        self.created_at = datetime.now()
        
        # 초대자에게 7일 연장 혜택 부여
        self.extend_membership(inviter_id, 7)
        self.is_claimed = True
        self.applied_at = datetime.now()
        
    def extend_membership(self, user_id, days):
        """회원권 연장"""
        user = User.get_by_id(user_id)
        current_total_extension = self.get_total_extension_days(user_id)
        
        # 최대 3개월(90일) 제한 확인
        if current_total_extension + days <= 90:
            user.extend_free_period(days)
            return True
        else:
            # 90일 한도 초과시 남은 일수만 연장
            remaining_days = 90 - current_total_extension
            if remaining_days > 0:
                user.extend_free_period(remaining_days)
            return False
```

### 초대 프로세스 플로우
```yaml
초대_프로세스:
  1. 초대자가 초대 코드 생성
  2. 초대 링크를 친구에게 공유
  3. 친구가 링크를 통해 회원가입
  4. 시스템이 초대 관계 확인
  5. 초대자에게 7일 연장 혜택 자동 지급
  6. 피초대자는 신규 가입 혜택 (7일 무료) 제공

제한_사항:
  - 초대자당 최대 연장 기간: 3개월 (90일)
  - 코드 유효 기간: 90일
  - 코드당 최대 사용 횟수: 50회
  - 자가 초대 방지 로직 구현
```

## 🎫 쿠폰 시스템

### 쿠폰 유형 설계
```python
# models/Coupon.py
class Coupon:
    """쿠폰 시스템 모델"""
    
    def __init__(self):
        self.coupon_id = None        # 쿠폰 고유 ID
        self.code = None             # 쿠폰 코드
        self.name = None             # 쿠폰 이름
        self.description = None      # 쿠폰 설명
        self.coupon_type = None      # 쿠폰 유형
        self.discount_type = None    # 할인 유형
        self.discount_value = None   # 할인 값
        self.min_purchase_amount = 0 # 최소 구매 금액
        self.max_discount_amount = None # 최대 할인 금액
        self.usage_limit = None      # 사용 횟수 제한
        self.used_count = 0          # 사용된 횟수
        self.start_date = None       # 시작 일시
        self.end_date = None         # 종료 일시
        self.target_users = []       # 대상 사용자 (빈 배열시 전체)
        self.target_membership = []  # 대상 회원 등급
        self.is_active = True        # 활성 상태
        self.created_by = None       # 생성자 (관리자 ID)
        self.created_at = None       # 생성 일시

# 쿠폰 유형 정의
COUPON_TYPES = {
    'subscription_discount': '구독료 할인',
    'commission_discount': '수수료 할인', 
    'free_trial_extension': '무료 체험 연장',
    'premium_upgrade': '프리미엄 업그레이드',
    'lifetime_discount': '라이프타임 할인'
}

DISCOUNT_TYPES = {
    'percentage': '퍼센트 할인',
    'fixed_amount': '고정 금액 할인',
    'free_period': '무료 기간 제공'
}

class CouponService:
    """쿠폰 서비스 클래스"""
    
    @staticmethod
    def create_coupon(admin_id, coupon_data):
        """관리자 쿠폰 생성"""
        import random
        import string
        from datetime import datetime
        
        coupon = Coupon()
        coupon.code = CouponService.generate_coupon_code()
        coupon.name = coupon_data['name']
        coupon.description = coupon_data['description']
        coupon.coupon_type = coupon_data['coupon_type']
        coupon.discount_type = coupon_data['discount_type']
        coupon.discount_value = coupon_data['discount_value']
        coupon.min_purchase_amount = coupon_data.get('min_purchase_amount', 0)
        coupon.max_discount_amount = coupon_data.get('max_discount_amount')
        coupon.usage_limit = coupon_data.get('usage_limit')
        coupon.start_date = coupon_data['start_date']
        coupon.end_date = coupon_data['end_date']
        coupon.target_users = coupon_data.get('target_users', [])
        coupon.target_membership = coupon_data.get('target_membership', [])
        coupon.created_by = admin_id
        coupon.created_at = datetime.now()
        
        return coupon.save()
    
    @staticmethod
    def generate_coupon_code():
        """쿠폰 코드 생성 (12자리)"""
        return ''.join(random.choices(
            string.ascii_uppercase + string.digits, k=12
        ))
    
    @staticmethod
    def validate_coupon(code, user_id, purchase_amount=0):
        """쿠폰 유효성 검증"""
        from datetime import datetime
        
        coupon = Coupon.get_by_code(code)
        if not coupon:
            return {'valid': False, 'reason': '존재하지 않는 쿠폰입니다.'}
        
        # 활성 상태 확인
        if not coupon.is_active:
            return {'valid': False, 'reason': '비활성화된 쿠폰입니다.'}
        
        # 기간 확인
        now = datetime.now()
        if now < coupon.start_date or now > coupon.end_date:
            return {'valid': False, 'reason': '쿠폰 사용 기간이 아닙니다.'}
        
        # 사용 횟수 확인
        if coupon.usage_limit and coupon.used_count >= coupon.usage_limit:
            return {'valid': False, 'reason': '쿠폰 사용 한도를 초과했습니다.'}
        
        # 대상 사용자 확인
        if coupon.target_users and user_id not in coupon.target_users:
            return {'valid': False, 'reason': '쿠폰 사용 대상이 아닙니다.'}
        
        # 최소 구매 금액 확인
        if purchase_amount < coupon.min_purchase_amount:
            return {'valid': False, 'reason': f'최소 구매 금액 {coupon.min_purchase_amount:,}원 이상이어야 합니다.'}
        
        # 회원 등급 확인
        user = User.get_by_id(user_id)
        if coupon.target_membership and user.membership_type not in coupon.target_membership:
            return {'valid': False, 'reason': '해당 회원 등급은 쿠폰을 사용할 수 없습니다.'}
        
        return {'valid': True, 'coupon': coupon}
    
    @staticmethod
    def apply_coupon(coupon, user_id, purchase_amount):
        """쿠폰 적용"""
        discount_amount = 0
        
        if coupon.discount_type == 'percentage':
            discount_amount = purchase_amount * (coupon.discount_value / 100)
            if coupon.max_discount_amount:
                discount_amount = min(discount_amount, coupon.max_discount_amount)
                
        elif coupon.discount_type == 'fixed_amount':
            discount_amount = coupon.discount_value
            
        elif coupon.discount_type == 'free_period':
            # 무료 기간 제공 로직
            user = User.get_by_id(user_id)
            user.extend_free_period(coupon.discount_value)
            discount_amount = purchase_amount  # 전액 할인
        
        # 쿠폰 사용 기록
        coupon.used_count += 1
        coupon.save()
        
        # 사용 이력 저장
        CouponUsage.create({
            'coupon_id': coupon.coupon_id,
            'user_id': user_id,
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount,
            'used_at': datetime.now()
        })
        
        return {
            'original_amount': purchase_amount,
            'discount_amount': discount_amount,
            'final_amount': purchase_amount - discount_amount
        }
```

### 관리자 쿠폰 관리 페이지
```javascript
// AdminCouponManager.jsx
import React, { useState, useEffect } from 'react'
import {
  Box, Card, CardContent, Typography, Button, Dialog,
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  TextField, Select, MenuItem, FormControl, InputLabel,
  Chip, Grid, Alert, IconButton
} from '@mui/material'
import {
  Add, Edit, Delete, Visibility, GetApp
} from '@mui/icons-material'

function AdminCouponManager() {
  const [coupons, setCoupons] = useState([])
  const [createDialog, setCreateDialog] = useState(false)
  const [newCoupon, setNewCoupon] = useState({
    name: '',
    description: '',
    coupon_type: 'subscription_discount',
    discount_type: 'percentage',
    discount_value: '',
    min_purchase_amount: 0,
    max_discount_amount: '',
    usage_limit: '',
    start_date: '',
    end_date: '',
    target_membership: []
  })

  const handleCreateCoupon = async () => {
    try {
      const response = await fetch('/api/admin/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCoupon)
      })
      
      if (response.ok) {
        const createdCoupon = await response.json()
        setCoupons([...coupons, createdCoupon])
        setCreateDialog(false)
        setNewCoupon({})
      }
    } catch (error) {
      console.error('쿠폰 생성 실패:', error)
    }
  }

  const getCouponStatusColor = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return 'error'
    if (now < startDate) return 'warning'
    if (now > endDate) return 'default'
    return 'success'
  }

  const getCouponStatusText = (coupon) => {
    const now = new Date()
    const startDate = new Date(coupon.start_date)
    const endDate = new Date(coupon.end_date)
    
    if (!coupon.is_active) return '비활성'
    if (now < startDate) return '대기중'
    if (now > endDate) return '만료됨'
    return '활성'
  }

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h5">🎫 쿠폰 관리</Typography>
        <Button
          variant="contained"
          startIcon={<Add />}
          onClick={() => setCreateDialog(true)}
        >
          쿠폰 생성
        </Button>
      </Box>

      {/* 쿠폰 통계 */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="primary">
                {coupons.filter(c => c.is_active).length}
              </Typography>
              <Typography variant="body2">활성 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="success.main">
                {coupons.reduce((sum, c) => sum + c.used_count, 0)}
              </Typography>
              <Typography variant="body2">총 사용 횟수</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="warning.main">
                {coupons.filter(c => new Date() < new Date(c.start_date)).length}
              </Typography>
              <Typography variant="body2">예약된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} md={3}>
          <Card>
            <CardContent>
              <Typography variant="h6" color="error.main">
                {coupons.filter(c => new Date() > new Date(c.end_date)).length}
              </Typography>
              <Typography variant="body2">만료된 쿠폰</Typography>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* 쿠폰 목록 */}
      <Card>
        <CardContent>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>쿠폰명</TableCell>
                  <TableCell>코드</TableCell>
                  <TableCell>유형</TableCell>
                  <TableCell>할인값</TableCell>
                  <TableCell>사용횟수</TableCell>
                  <TableCell>기간</TableCell>
                  <TableCell>상태</TableCell>
                  <TableCell>관리</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {coupons.map((coupon) => (
                  <TableRow key={coupon.coupon_id}>
                    <TableCell>
                      <Typography variant="body2" fontWeight="bold">
                        {coupon.name}
                      </Typography>
                      <Typography variant="caption" color="textSecondary">
                        {coupon.description}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" fontFamily="monospace">
                        {coupon.code}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {coupon.coupon_type}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {coupon.discount_type === 'percentage' 
                        ? `${coupon.discount_value}%`
                        : `${coupon.discount_value:,}원`}
                    </TableCell>
                    <TableCell>
                      {coupon.used_count} / {coupon.usage_limit || '무제한'}
                    </TableCell>
                    <TableCell>
                      <Typography variant="caption">
                        {new Date(coupon.start_date).toLocaleDateString()} ~<br/>
                        {new Date(coupon.end_date).toLocaleDateString()}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Chip 
                        label={getCouponStatusText(coupon)}
                        color={getCouponStatusColor(coupon)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell>
                      <IconButton size="small">
                        <Visibility />
                      </IconButton>
                      <IconButton size="small">
                        <Edit />
                      </IconButton>
                      <IconButton size="small" color="error">
                        <Delete />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </CardContent>
      </Card>

      {/* 쿠폰 생성 다이얼로그 */}
      <Dialog 
        open={createDialog} 
        onClose={() => setCreateDialog(false)}
        maxWidth="md"
        fullWidth
      >
        {/* 쿠폰 생성 폼 구현 */}
      </Dialog>
    </Box>
  )
}

export default AdminCouponManager
```

## 🔄 구현 우선순위

### Phase 2A-Extended: 회원 시스템 고도화 (D+1 ~ D+21)

#### Week 1: 회원 등급 시스템 수정
```powershell
# 1. 회원 모델 업데이트
# User 모델에 새로운 필드 추가
- free_trial_end_date    # 무료 체험 종료일
- daily_trade_count      # 일일 거래 횟수
- total_extension_days   # 총 연장 일수
- referral_code          # 개인 초대 코드

# 2. 거래 제한 로직 구현
# TradeController에서 회원 등급별 제한 체크
```

#### Week 2: 친구 초대 시스템
```powershell
# 1. 초대 코드 생성 기능
# ReferralCode 모델 및 서비스 구현

# 2. 초대 링크 처리
# 회원가입 시 초대 코드 확인 로직

# 3. 보상 지급 시스템
# 자동 연장 및 한도 관리
```

#### Week 3: 쿠폰 시스템
```powershell
# 1. 쿠폰 모델 및 서비스 구현
# Coupon, CouponUsage 모델 생성

# 2. 관리자 쿠폰 관리 페이지
# AdminCouponManager 컴포넌트 구현

# 3. 쿠폰 적용 로직
# 결제 시스템과 연동
```

## 📊 데이터베이스 스키마 설계

### 새로운 테이블 구조
```sql
-- 초대 코드 테이블
CREATE TABLE referral_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    code VARCHAR(8) UNIQUE NOT NULL,
    invite_url VARCHAR(255) NOT NULL,
    max_uses INT DEFAULT 50,
    current_uses INT DEFAULT 0,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 초대 보상 테이블
CREATE TABLE referral_rewards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    inviter_id BIGINT NOT NULL,
    invitee_id BIGINT NOT NULL,
    referral_code VARCHAR(8) NOT NULL,
    reward_days INT DEFAULT 7,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_at TIMESTAMP,
    is_claimed BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (inviter_id) REFERENCES users(id),
    FOREIGN KEY (invitee_id) REFERENCES users(id)
);

-- 쿠폰 테이블
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(12) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    coupon_type ENUM('subscription_discount', 'commission_discount', 'free_trial_extension', 'premium_upgrade', 'lifetime_discount') NOT NULL,
    discount_type ENUM('percentage', 'fixed_amount', 'free_period') NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_purchase_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INT,
    used_count INT DEFAULT 0,
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    target_membership JSON,
    target_users JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 쿠폰 사용 이력 테이블
CREATE TABLE coupon_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coupon_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    final_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (coupon_id) REFERENCES coupons(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 사용자 테이블 수정 (새 컬럼 추가)
ALTER TABLE users ADD COLUMN free_trial_end_date DATETIME;
ALTER TABLE users ADD COLUMN daily_trade_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN daily_trade_reset_date DATE;
ALTER TABLE users ADD COLUMN total_extension_days INT DEFAULT 0;
ALTER TABLE users ADD COLUMN personal_referral_code VARCHAR(8) UNIQUE;
```

## 🎯 비즈니스 로직 구현

### 거래 제한 검증 서비스
```python
# services/TradingLimitService.py
class TradingLimitService:
    """거래 제한 관리 서비스"""
    
    @staticmethod
    def can_make_trade(user_id, trade_type='demo'):
        """거래 가능 여부 확인"""
        user = User.get_by_id(user_id)
        
        # 비회원은 모든 거래 차단
        if not user or not user.is_authenticated:
            return {
                'allowed': False,
                'reason': '로그인이 필요합니다.',
                'redirect_to': '/login'
            }
        
        # 라이프타임/프리미엄 회원은 무제한
        if user.membership_type in ['lifetime', 'premium']:
            return {'allowed': True}
        
        # 무료 회원 제한 로직
        if user.membership_type == 'free':
            # 신규 가입 7일 무료 기간 확인
            if user.is_in_free_trial():
                return {'allowed': True}
            
            # 일일 거래 제한 확인 (매수 1회, 매도 1회)
            today_trades = user.get_today_trade_count()
            if today_trades >= 2:
                return {
                    'allowed': False,
                    'reason': '일일 거래 횟수를 초과했습니다. (2회/일)',
                    'upgrade_suggested': True
                }
            
            # 실전 거래는 차단
            if trade_type == 'real':
                return {
                    'allowed': False,
                    'reason': '실전 거래는 유료 회원만 이용 가능합니다.',
                    'upgrade_required': True
                }
        
        return {'allowed': True}
    
    @staticmethod
    def record_trade(user_id, trade_type):
        """거래 기록"""
        user = User.get_by_id(user_id)
        
        if user.membership_type == 'free':
            # 일일 거래 횟수 증가
            from datetime import date
            today = date.today()
            
            if user.daily_trade_reset_date != today:
                user.daily_trade_count = 0
                user.daily_trade_reset_date = today
            
            user.daily_trade_count += 1
            user.save()
```

## 📱 UI/UX 개선사항

### 회원가입 플로우 