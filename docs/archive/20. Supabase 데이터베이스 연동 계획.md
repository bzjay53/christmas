# Supabase 데이터베이스 연동 계획

## 개요
Christmas 프로젝트의 주문 및 사용자 데이터를 관리하기 위해 Supabase를 백엔드 데이터베이스로 활용하는 계획을 수립합니다. 현재는 메모리 내 데이터 구조를 사용하고 있으나, 실제 사용자 테스트 및 프로덕션 환경에서는 영구적인 데이터 저장소가 필요합니다.

## Supabase 소개
Supabase는 Firebase의 오픈소스 대안으로, PostgreSQL 데이터베이스를 기반으로 한 백엔드 서비스입니다. 인증, 실시간 구독, 스토리지 등 다양한 기능을 제공합니다.

## 구현 계획

### 1. Supabase 프로젝트 설정 (1일)
- [x] 1.1 Supabase 계정 생성
- [x] 1.2 새 프로젝트 생성
- [x] 1.3 API 키 및 URL 발급
- [x] 1.4 환경 변수 설정

### 2. 데이터베이스 스키마 설계 (2일)
- [x] 2.1 사용자 테이블 설계
- [x] 2.2 주문 테이블 설계
- [x] 2.3 포지션 테이블 설계
- [x] 2.4 전략 테이블 설계
- [x] 2.5 성능 지표 테이블 설계
- [x] 2.6 관계 및 제약조건 설정

### 3. Supabase 클라이언트 통합 (2일)
- [x] 3.1 Supabase JavaScript 클라이언트 설치
- [x] 3.2 Python Supabase 클라이언트 설치
- [x] 3.3 API 래퍼 클래스 구현
- [x] 3.4 인증 모듈 연동

### 4. 데이터 액세스 레이어 구현 (3일)
- [x] 4.1 사용자 데이터 액세스 구현
- [x] 4.2 주문 데이터 액세스 구현
- [x] 4.3 포지션 데이터 액세스 구현
- [x] 4.4 전략 데이터 액세스 구현
- [x] 4.5 성능 지표 데이터 액세스 구현

### 5. 주문 처리 시스템 연동 (3일)
- [x] 5.1 OrderService와 Supabase 통합
- [x] 5.2 주문 상태 변경 이벤트 처리
- [x] 5.3 주문 이력 저장 구현
- [x] 5.4 포지션 업데이트 처리

### 6. 실시간 기능 구현 (2일)
- [ ] 6.1 실시간 주문 상태 구독 설정
- [ ] 6.2 실시간 포지션 업데이트 구현
- [ ] 6.3 실시간 성능 지표 업데이트 구현
- [x] 6.4 텔레그램 기반 알림 연동 (완료)

### 7. 테스트 및 검증 (2일)
- [x] 7.1 단위 테스트 작성
- [x] 7.2 통합 테스트 작성
- [ ] 7.3 성능 테스트 작성
- [ ] 7.4 장애 복구 테스트 작성

### 8. 문서화 및 최적화 (1일)
- [x] 8.1 스키마 문서화
- [x] 8.2 API 사용 예제 작성
- [ ] 8.3 인덱스 최적화
- [ ] 8.4 쿼리 최적화

## 구현 현황
현재까지 다음 항목들이 완료되었습니다:

1. **데이터베이스 스키마 설계**: 사용자, 주문, 포지션, 전략, 성능 지표 테이블에 대한 스키마 설계 완료
2. **Supabase 클라이언트 구현**: 싱글톤 패턴을 적용한 SupabaseClient 클래스 구현
3. **주문 데이터 리포지토리 구현**: OrderRepository 클래스를 통한 주문 데이터 액세스 레이어 구현
4. **OrderService 확장**: SupabaseOrderService 클래스를 통해 기존 OrderService에 데이터베이스 연동 기능 추가
5. **텔레그램 알림 시스템**: 주문 상태 변경 시 텔레그램을 통한 실시간 알림 기능 구현 완료
6. **테스트 스크립트 작성**: Supabase 및 텔레그램 연동 테스트를 위한 스크립트 작성 완료

다음으로 진행할 작업:
1. 실시간 데이터 구독 기능 구현
2. 성능 테스트 및 장애 복구 테스트
3. 인덱스 및 쿼리 최적화

## 예상 소요 시간
총 14/16일 소요 (87.5% 완료)

## 주요 고려사항

### 보안
- 데이터베이스 수준의 행 수준 보안(RLS) 구현
- API 키 관리 및 로테이션 전략
- 사용자 인증 및 권한 관리

### 성능
- 인덱스 설계 및 최적화
- 배치 작업 및 대량 데이터 처리
- 캐싱 전략

### 비용
- 데이터 저장 및 전송 비용 모니터링
- 필요한 서비스 티어 선택
- 비용 최적화 전략

## 마이그레이션 계획
1. 테스트 환경에서 먼저 구현 및 검증
2. 기존 메모리 기반 구현과 병렬로 운영 (shadow mode)
3. 점진적인 기능 전환
4. 최종 전환 및 검증

## 예상되는 문제점 및 해결 방안
1. **데이터 일관성**: 분산 시스템에서의 일관성 문제를 해결하기 위해 트랜잭션 사용
2. **네트워크 지연**: 로컬 캐싱 및 낙관적 UI 업데이트 구현
3. **스키마 변경**: 마이그레이션 스크립트 및 버전 관리 체계 수립
4. **서비스 중단**: 무중단 전환 전략 및 롤백 계획 수립 