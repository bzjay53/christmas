# Christmas Trading - Development Dockerfile
# Hot reloadì™€ ê°œë°œ ë„êµ¬ë¥¼ í¬í•¨í•œ ê°œë°œ í™˜ê²½

FROM node:18-alpine

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apk add --no-cache \
    python3 \
    py3-pip \
    sqlite \
    curl \
    bash \
    git

# Python ì˜ì¡´ì„± ì„¤ì¹˜
RUN pip3 install --no-cache-dir \
    aiohttp \
    asyncio

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=development
ENV VITE_APP_ENV=development
ENV PYTHONUNBUFFERED=1

# Package files ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm install

# ê°œë°œ ë„êµ¬ ì¶”ê°€ ì„¤ì¹˜
RUN npm install -g nodemon concurrently

# MCP ì„œë¹„ìŠ¤ íŒŒì¼ë“¤ ë³µì‚¬
COPY gemini_mcp_server.py ./
COPY task-master-integration.py ./
COPY memory-bank-integration.py ./
COPY mcp-config.json ./

# í™˜ê²½ ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY .env.example ./
COPY tsconfig*.json ./
COPY vite.config.ts ./
COPY eslint.config.js ./

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p logs data

# ê°œë°œ ì„œë²„ í¬íŠ¸
EXPOSE 5173 8001 8002 8003

# ê°œë°œ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN cat > dev-start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸ„ Christmas Trading Development Environment Starting..."

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
export VITE_ENABLE_MOCK_DATA=true

# ë°ì´í„°ë² ì´ìŠ¤ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
chmod 755 /app/data

# MCP ì„œë¹„ìŠ¤ë“¤ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘
echo "ğŸ”§ Starting MCP Services (Development)..."

# Task Master MCP
python3 task-master-integration.py > logs/task-master-dev.log 2>&1 &

# Memory Bank MCP
python3 memory-bank-integration.py > logs/memory-bank-dev.log 2>&1 &

# Gemini MCP (API í‚¤ê°€ ìˆëŠ” ê²½ìš°ë§Œ)
if [ -n "$GEMINI_API_KEY" ]; then
    python3 gemini_mcp_server.py > logs/gemini-mcp-dev.log 2>&1 &
fi

# ì ì‹œ ëŒ€ê¸°
sleep 2

echo "ğŸš€ Starting Vite Development Server..."
# Vite ê°œë°œ ì„œë²„ ì‹œì‘
npm run dev -- --host 0.0.0.0
EOF

RUN chmod +x dev-start.sh

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:5173 || exit 1

# ì‹œì‘ ëª…ë ¹
CMD ["./dev-start.sh"]