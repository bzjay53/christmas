name: Deploy to Netlify

on:
  push:
    branches: [ main, mobile-optimization ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“± Send deployment start notification
      if: github.event_name == 'push'
      run: |
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>ë°°í¬ ì‹œì‘</b>%0A%0AğŸŒ <b>í™˜ê²½:</b> Production%0AğŸ“¦ <b>ë¸Œëœì¹˜:</b> ${{ github.ref_name }}%0AğŸ‘¤ <b>ì‘ì„±ì:</b> ${{ github.actor }}%0AğŸ“ <b>ì»¤ë°‹:</b> ${{ github.event.head_commit.message }}%0A%0Aâ° <b>ì‹œì‘ì‹œê°„:</b> $(date '+%Y-%m-%d %H:%M:%S')"
        fi
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'web-dashboard/package-lock.json'
        
    - name: ğŸ“¦ Install dependencies
      working-directory: ./web-dashboard
      run: npm ci
      
    - name: ğŸ§ª Run tests
      working-directory: ./web-dashboard
      run: npm run test:ci || true
      
    - name: ğŸ—ï¸ Build application
      working-directory: ./web-dashboard
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.VITE_TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.VITE_TELEGRAM_CHAT_ID }}
      run: npm run build
      
    - name: ğŸ” Run Lighthouse CI
      working-directory: ./web-dashboard
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun || true
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        
    - name: ğŸš€ Deploy to Netlify
      id: deploy
      uses: nwtgck/actions-netlify@v3.0
      with:
        publish-dir: './web-dashboard/dist'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions - ${{ github.event.head_commit.message }}"
        enable-pull-request-comment: true
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: ğŸ“Š Performance Budget Check
      working-directory: ./web-dashboard
      run: |
        echo "ğŸ¯ Performance Budget Check"
        echo "âœ… Bundle size: $(du -sh dist/ | cut -f1)"
        
    - name: ğŸ“± Send deployment success notification
      if: success() && github.event_name == 'push'
      run: |
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          DEPLOY_URL="${{ steps.deploy.outputs.deploy-url }}"
          BUILD_SIZE=$(du -sh web-dashboard/dist/ | cut -f1)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… <b>ë°°í¬ ì„±ê³µ</b>%0A%0AğŸŒ <b>í™˜ê²½:</b> Production%0AğŸ“¦ <b>ë¸Œëœì¹˜:</b> ${{ github.ref_name }}%0AğŸ”— <b>URL:</b> ${DEPLOY_URL}%0AğŸ“Š <b>ë¹Œë“œ í¬ê¸°:</b> ${BUILD_SIZE}%0AğŸ‘¤ <b>ì‘ì„±ì:</b> ${{ github.actor }}%0A%0AğŸ“ <b>ë³€ê²½ì‚¬í•­:</b>%0A${{ github.event.head_commit.message }}%0A%0Aâ° <b>ì™„ë£Œì‹œê°„:</b> $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        
    - name: ğŸ“± Send deployment failure notification
      if: failure() && github.event_name == 'push'
      run: |
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âŒ <b>ë°°í¬ ì‹¤íŒ¨</b>%0A%0AğŸŒ <b>í™˜ê²½:</b> Production%0AğŸ“¦ <b>ë¸Œëœì¹˜:</b> ${{ github.ref_name }}%0AğŸ‘¤ <b>ì‘ì„±ì:</b> ${{ github.actor }}%0AğŸ”— <b>ë¡œê·¸:</b> https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0AğŸ“ <b>ì»¤ë°‹:</b>%0A${{ github.event.head_commit.message }}%0A%0Aâ° <b>ì‹¤íŒ¨ì‹œê°„:</b> $(date '+%Y-%m-%d %H:%M:%S')%0A%0AğŸ”§ <b>ì¡°ì¹˜ì‚¬í•­:</b> ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
        fi 